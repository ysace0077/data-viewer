<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Viewer Pro</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
    background: linear-gradient(to bottom, #f8f9fa 0%, #e9ecef 100%);
    min-height: 100vh;
    color: #212529;
    line-height: 1.6;
}

/* ë°°ê²½ íŒ¨í„´ íš¨ê³¼ */
body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: 
        repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.01) 2px, rgba(0,0,0,0.01) 4px),
        repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(0,0,0,0.01) 2px, rgba(0,0,0,0.01) 4px);
    pointer-events: none;
    z-index: 0;
}

.container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 32px 24px;
    position: relative;
    z-index: 1;
}

/* í—¤ë” */
.header {
    text-align: center;
    margin-bottom: 40px;
    animation: fadeInDown 0.6s ease-out;
    padding: 20px 0;
}

.header h1 {
    font-size: 2.8em;
    font-weight: 700;
    color: #212529;
    margin-bottom: 12px;
    letter-spacing: -1px;
}

.header p {
    color: #6c757d;
    font-size: 1.1em;
    font-weight: 400;
    letter-spacing: 0.3px;
}

/* íƒ­ ì»¨í…Œì´ë„ˆ */
.tab-container {
    display: flex;
    gap: 16px;
    justify-content: center;
    margin-bottom: 32px;
    padding: 8px;
    background: white;
    border-radius: 16px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
}

.tab-btn {
    flex: 1;
    padding: 14px 32px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: transparent;
    color: #6c757d;
    letter-spacing: 0.5px;
}

.tab-btn:hover {
    background: #f8f9fa;
    color: #495057;
}

.tab-btn.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    transform: translateY(-1px);
}

/* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
.card {
    background: white;
    border: none;
    border-radius: 20px;
    overflow: hidden;
    margin-bottom: 24px;
    animation: fadeInUp 0.6s ease-out;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

/* ì—…ë¡œë“œ ì„¹ì…˜ */
.upload-section {
    padding: 32px;
    text-align: center;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-bottom: 1px solid #e9ecef;
}

.upload-section h3 {
    font-size: 1.3em;
    color: #212529;
    margin-bottom: 20px;
    font-weight: 600;
}

.file-input label {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 16px 40px;
    border-radius: 12px;
    cursor: pointer;
    font-size: 15px;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: inline-flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
}

.file-input label:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 28px rgba(102, 126, 234, 0.4);
}

.file-input input {
    display: none;
}

.file-info {
    margin-top: 16px;
    padding: 12px 20px;
    background: #f8f9fa;
    border-radius: 10px;
    color: #495057;
    font-weight: 500;
    font-size: 0.9em;
    border: 1px solid #dee2e6;
}

/* íƒ­ ì»¨í…ì¸  */
.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

/* ê²€ìƒ‰ íŒ¨ë„ */
.search-panel {
    padding: 32px;
}

.search-panel h3 {
    color: #212529;
    margin-bottom: 28px;
    font-size: 1.4em;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
    padding-bottom: 16px;
    border-bottom: 2px solid #e9ecef;
}

.search-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
    margin-bottom: 28px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    margin-bottom: 8px;
    font-size: 0.9em;
    color: #495057;
    font-weight: 600;
    letter-spacing: 0.3px;
}

select {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #dee2e6;
    border-radius: 10px;
    font-size: 14px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: #f8f9fa;
    color: #212529;
    font-family: inherit;
    font-weight: 500;
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23667eea' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 18px;
    padding-right: 42px;
}

select:hover {
    border-color: #adb5bd;
    background: white;
}

select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    background: white;
}

select option {
    background: white;
    color: #212529;
    padding: 12px;
}

.search-actions {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 16px;
    margin-top: 28px;
    align-items: center;
}

.btn {
    padding: 14px 28px;
    border: none;
    border-radius: 12px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-family: inherit;
    letter-spacing: 0.3px;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
}

.btn-primary:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 28px rgba(102, 126, 234, 0.4);
}

.btn-secondary {
    background: white;
    color: #6c757d;
    border: 2px solid #dee2e6;
}

.btn-secondary:hover {
    background: #f8f9fa;
    border-color: #adb5bd;
    color: #495057;
    transform: translateY(-2px);
}

.btn-success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
}

.btn-success:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 28px rgba(16, 185, 129, 0.4);
}

.export-info {
    font-size: 0.85em;
    color: #6c757d;
    text-align: center;
    font-weight: 500;
    grid-column: 1 / -1;
    margin-top: 12px;
    padding: 8px;
    background: #f8f9fa;
    border-radius: 8px;
}

/* ê²°ê³¼ íŒ¨ë„ */
.results-panel {
    background: white;
    border: none;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.results-header {
    padding: 24px 32px;
    border-bottom: 2px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
}

.results-header h3 {
    color: #212529;
    font-size: 1.4em;
    font-weight: 600;
}

.pagination {
    display: flex;
    align-items: center;
    gap: 16px;
    color: #495057;
    font-size: 0.95em;
    font-weight: 600;
}

.pagination-btn {
    padding: 10px 18px;
    border: 2px solid #dee2e6;
    background: white;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-weight: 600;
    color: #495057;
}

.pagination-btn:hover:not(:disabled) {
    border-color: #667eea;
    background: #f8f9fa;
    color: #667eea;
    transform: translateY(-2px);
}

.pagination-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

/* ì¹´ë“œ ë·° */
.card-view {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    padding: 32px;
    gap: 24px;
    background: #f8f9fa;
}

.data-card {
    background: white;
    border: none;
    border-radius: 16px;
    padding: 24px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
}

.data-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 5px;
    height: 100%;
    background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
}

.data-card:hover {
    box-shadow: 0 8px 28px rgba(0, 0, 0, 0.12);
    transform: translateY(-4px);
}

.card-header {
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 2px solid #e9ecef;
}

.card-customer {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
}

.card-number {
    font-size: 1.3em;
    font-weight: 700;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.card-name {
    font-size: 1.2em;
    font-weight: 700;
    color: #212529;
}

.card-location {
    font-size: 0.85em;
    color: #6c757d;
    padding: 6px 12px;
    background: #e9ecef;
    border-radius: 8px;
    font-weight: 600;
}

.card-body {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.card-section {
    display: flex;
    align-items: flex-start;
    font-size: 0.95em;
    line-height: 1.7;
    padding: 6px 0;
}

.card-content {
    flex: 1;
}

.card-label {
    font-weight: 700;
    color: #6c757d;
    min-width: 80px;
    display: inline-block;
}

.card-value {
    color: #212529;
    margin-left: 8px;
    font-weight: 500;
}

.card-value.product {
    color: #667eea;
    font-weight: 700;
}

.card-value.money {
    color: #10b981;
    font-weight: 800;
    font-family: 'SF Mono', Monaco, 'Courier New', monospace;
}

.card-value.discount {
    color: #ef4444;
    font-weight: 700;
}

.card-value.gift {
    color: #8b5cf6;
    font-weight: 700;
}

.card-value.repurchase {
    color: #10b981;
    font-weight: 700;
    background: #d1fae5;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 0.85em;
}

.card-value.seller {
    color: #212529;
    font-weight: 700;
}

.card-value.discount-rate {
    color: #f97316;
    font-weight: 800;
    font-family: 'SF Mono', Monaco, 'Courier New', monospace;
}

/* ìƒíƒœ ë©”ì‹œì§€ */
.status {
    padding: 18px 28px;
    margin: 20px 0;
    border-radius: 14px;
    font-weight: 600;
    font-size: 1em;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    border: none;
}

.status.info {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    color: #1e40af;
}

.status.success {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #065f46;
}

.status.error {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    color: #991b1b;
}

.status.loading {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    color: #92400e;
}

.empty-state {
    text-align: center;
    padding: 100px 20px;
    color: #adb5bd;
}

.empty-state .icon {
    font-size: 5em;
    margin-bottom: 24px;
    opacity: 0.3;
}

@keyframes fadeInDown {
    from {
        opacity: 0;
        transform: translateY(-30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@media (max-width: 1200px) {
    .search-grid {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (max-width: 1024px) {
    .search-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .card-view {
        grid-template-columns: 1fr;
    }
    
    .search-actions {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .container {
        padding: 16px;
    }
    
    .header h1 {
        font-size: 1.8em;
    }
    
    .search-panel {
        padding: 16px;
    }
    
    .search-grid {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .search-actions {
        grid-template-columns: 1fr;
    }
    
    .tab-container {
        gap: 8px;
    }
    
    .tab-btn {
        padding: 8px 24px;
        font-size: 14px;
    }
    
    .card-view {
        padding: 16px;
        gap: 16px;
    }
}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>âœ¨ Data Viewer Pro</h1>
        <p>Advanced Database Analytics Platform</p>
    </div>

    <!-- íŒŒì¼ ì—…ë¡œë“œ -->
    <div class="card">
        <div class="upload-section">
            <h3>ğŸ“ ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ ì„ íƒ</h3>
            <div class="file-input">
                <label for="db-file">
                    <span>ğŸ“‚</span>
                    <span>íŒŒì¼ ì„ íƒí•˜ê¸°</span>
                </label>
                <input type="file" id="db-file" accept=".db,.sqlite,.sqlite3">
            </div>
            <div class="file-info" id="file-info">ì„ íƒëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</div>
            <div id="upload-status"></div>
        </div>
    </div>

    <!-- íƒ­ ë²„íŠ¼ -->
    <div class="tab-container">
        <button class="tab-btn active" onclick="switchTab('ACE')">ACE</button>
        <button class="tab-btn" onclick="switchTab('ESSA')">ESSA</button>
    </div>

    <!-- ACE íƒ­ -->
    <div id="ace-tab" class="tab-content active">
        <div class="card">
            <div class="search-panel">
                <h3>ğŸ” ê²€ìƒ‰ ì¡°ê±´</h3>
                <div class="search-grid">
                    <div class="form-group">
                        <label>YEAR</label>
                        <select id="ace-year" onchange="handleYearMonthChange('ACE')">
                            <option value="">ì „ì²´</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>MONTH</label>
                        <select id="ace-month" onchange="handleYearMonthChange('ACE')">
                            <option value="">ì „ì²´</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ê³ ê°ëª…</label>
                        <select id="ace-customer">
                            <option value="">ì „ì²´</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ìƒí’ˆëª…</label>
                        <select id="ace-product">
                            <option value="">ì „ì²´</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ì§€ì—­1</label>
                        <select id="ace-region1" onchange="handleRegion1Change('ACE')">
                            <option value="">ì „ì²´</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ì§€ì—­2</label>
                        <select id="ace-region2" onchange="handleRegion2Change('ACE')">
                            <option value="">ì „ì²´</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ì§€ì—­3</label>
                        <select id="ace-region3">
                            <option value="">ì „ì²´</option>
                        </select>
                    </div>
                </div>
                <div class="search-actions">
                    <button class="btn btn-primary" onclick="executeSearch('ACE')">ê²€ìƒ‰ ì‹¤í–‰</button>
                    <button class="btn btn-secondary" onclick="clearSearch('ACE')">ì´ˆê¸°í™”</button>
                    <button class="btn btn-success" onclick="exportToExcel('ACE')">Excel ë‚´ë³´ë‚´ê¸°</button>
                    <div class="export-info" id="ace-export-info">í˜„ì¬ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë‚´ë³´ëƒ…ë‹ˆë‹¤</div>
                </div>
            </div>
        </div>

        <div class="results-panel">
            <div class="results-header">
                <h3>ğŸ“‹ ê²€ìƒ‰ ê²°ê³¼ <span id="ace-result-count" style="font-size: 0.7em; color: #94a3b8; font-weight: 500;"></span></h3>
                <div class="pagination">
                    <button class="pagination-btn" onclick="previousPage('ACE')" id="ace-prev-btn">â—€</button>
                    <span id="ace-page-info">1 í˜ì´ì§€</span>
                    <button class="pagination-btn" onclick="nextPage('ACE')" id="ace-next-btn">â–¶</button>
                </div>
            </div>
            <div class="card-view" id="ace-card-view">
                <div style="grid-column: 1 / -1; text-align: center; padding: 80px 20px; color: #64748b;">
                    <div style="font-size: 4em; margin-bottom: 20px; opacity: 0.4;">ğŸ“‡</div>
                    <div style="font-size: 1.2em; font-weight: 600;">ë°ì´í„°ë¥¼ ê²€ìƒ‰í•´ì£¼ì„¸ìš”</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ESSA íƒ­ -->
    <div id="essa-tab" class="tab-content">
        <div class="card">
            <div class="search-panel">
                <h3>ğŸ” ê²€ìƒ‰ ì¡°ê±´</h3>
                <div class="search-grid">
                    <div class="form-group">
                        <label>YEAR</label>
                        <select id="essa-year" onchange="handleYearMonthChange('ESSA')">
                            <option value="">ì „ì²´</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>MONTH</label>
                        <select id="essa-month" onchange="handleYearMonthChange('ESSA')">
                            <option value="">ì „ì²´</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ê³ ê°ëª…</label>
                        <select id="essa-customer">
                            <option value="">ì „ì²´</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ìƒí’ˆëª…</label>
                        <select id="essa-product">
                            <option value="">ì „ì²´</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ì§€ì—­1</label>
                        <select id="essa-region1" onchange="handleRegion1Change('ESSA')">
                            <option value="">ì „ì²´</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ì§€ì—­2</label>
                        <select id="essa-region2" onchange="handleRegion2Change('ESSA')">
                            <option value="">ì „ì²´</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ì§€ì—­3</label>
                        <select id="essa-region3">
                            <option value="">ì „ì²´</option>
                        </select>
                    </div>
                </div>
                <div class="search-actions">
                    <button class="btn btn-primary" onclick="executeSearch('ESSA')">ê²€ìƒ‰ ì‹¤í–‰</button>
                    <button class="btn btn-secondary" onclick="clearSearch('ESSA')">ì´ˆê¸°í™”</button>
                    <button class="btn btn-success" onclick="exportToExcel('ESSA')">Excel ë‚´ë³´ë‚´ê¸°</button>
                    <div class="export-info" id="essa-export-info">í˜„ì¬ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë‚´ë³´ëƒ…ë‹ˆë‹¤</div>
                </div>
            </div>
        </div>

        <div class="results-panel">
            <div class="results-header">
                <h3>ğŸ“‹ ê²€ìƒ‰ ê²°ê³¼ <span id="essa-result-count" style="font-size: 0.7em; color: #94a3b8; font-weight: 500;"></span></h3>
                <div class="pagination">
                    <button class="pagination-btn" onclick="previousPage('ESSA')" id="essa-prev-btn">â—€</button>
                    <span id="essa-page-info">1 í˜ì´ì§€</span>
                    <button class="pagination-btn" onclick="nextPage('ESSA')" id="essa-next-btn">â–¶</button>
                </div>
            </div>
            <div class="card-view" id="essa-card-view">
                <div style="grid-column: 1 / -1; text-align: center; padding: 80px 20px; color: #64748b;">
                    <div style="font-size: 4em; margin-bottom: 20px; opacity: 0.4;">ğŸ“‡</div>
                    <div style="font-size: 1.2em; font-weight: 600;">ë°ì´í„°ë¥¼ ê²€ìƒ‰í•´ì£¼ì„¸ìš”</div>
                </div>
            </div>
        </div>
    </div>

    <div id="status-area"></div>
</div>

<script>
let db = null;
let currentTab = 'ACE';
let aceResults = { columns: [], rows: [], currentPage: 1, pageSize: 50 };
let essaResults = { columns: [], rows: [], currentPage: 1, pageSize: 50 };
let customerPurchaseHistory = new Map();

// ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ì €ì¥
let aceDropdownOptions = {
    year: new Set(),
    month: new Set(),
    customer: new Set(),
    region1: new Set(),
    region2: new Set(),
    region3: new Set(),
    product: new Set()
};

let essaDropdownOptions = {
    year: new Set(),
    month: new Set(),
    customer: new Set(),
    region1: new Set(),
    region2: new Set(),
    region3: new Set(),
    product: new Set()
};

// ì „ì²´ ë°ì´í„° ìºì‹œ
let aceAllData = [];
let essaAllData = [];

// SQL.js ì´ˆê¸°í™”
function initializeSQL() {
    if (typeof initSqlJs === 'undefined') {
        document.getElementById('upload-status').innerHTML = '<div class="status loading">â³ SQL.js ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>';
        setTimeout(initializeSQL, 1000);
        return;
    }

    const config = {
        locateFile: filename => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${filename}`
    };

    initSqlJs(config).then(function(SQL) {
        window.SQL = SQL;
        showStatus('âœ… SQL.js ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'success');
        
        const fileInput = document.getElementById('db-file');
        fileInput.addEventListener('change', handleFileSelect);
    }).catch(function(error) {
        showStatus('âŒ SQL.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
        console.error('SQL.js ë¡œë“œ ì˜¤ë¥˜:', error);
    });
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    showStatus('ğŸš€ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì´ˆê¸°í™”í•˜ëŠ” ì¤‘...', 'loading');
    initializeSQL();
});

// íŒŒì¼ ì„ íƒ í•¸ë“¤ëŸ¬
function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) {
        showStatus('âš ï¸ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
        return;
    }

    document.getElementById('file-info').textContent = `ì„ íƒëœ íŒŒì¼: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
    showStatus('â³ ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', 'loading');

    const reader = new FileReader();
    reader.onload = function() {
        try {
            const Uints = new Uint8Array(reader.result);
            db = new SQL.Database(Uints);
            showStatus('â³ ë°ì´í„°ë² ì´ìŠ¤ ë¡œë“œ ì¤‘... ACE ë° ESSA ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤', 'loading');
            
            // ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ë¡œë“œ
            loadDropdownOptions('ACE');
            loadDropdownOptions('ESSA');
            
            // ìµœì¢… ì™„ë£Œ ë©”ì‹œì§€ (ì•½ê°„ì˜ ì§€ì—° í›„)
            setTimeout(() => {
                const aceCount = aceAllData.length;
                const essaCount = essaAllData.length;
                showStatus(`âœ… ëª¨ë“  ë°ì´í„° ë¡œë“œ ì™„ë£Œ! ACE: ${aceCount.toLocaleString()}ê°œ, ESSA: ${essaCount.toLocaleString()}ê°œ - ê²€ìƒ‰ ê°€ëŠ¥`, 'success');
            }, 500);
        } catch (error) {
            showStatus('âŒ íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
            console.error('File load error:', error);
        }
    };

    reader.onerror = function() {
        showStatus('âŒ íŒŒì¼ ì½ê¸° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    };

    reader.readAsArrayBuffer(file);
}

// ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ë¡œë“œ
function loadDropdownOptions(tabName) {
    if (!db) return;
    
    const tableName = `data_(${tabName})`;
    const options = tabName === 'ACE' ? aceDropdownOptions : essaDropdownOptions;
    
    try {
        // ì „ì²´ ë°ì´í„° ë¡œë“œ
        const query = `SELECT * FROM "${tableName}"`;
        const result = db.exec(query);
        
        if (result.length > 0) {
            const columns = result[0].columns;
            const rows = result[0].values;
            
            // ë°ì´í„° ìºì‹œ ì €ì¥
            if (tabName === 'ACE') {
                aceAllData = rows.map(row => {
                    const obj = {};
                    columns.forEach((col, idx) => {
                        obj[col] = row[idx];
                    });
                    return obj;
                });
            } else {
                essaAllData = rows.map(row => {
                    const obj = {};
                    columns.forEach((col, idx) => {
                        obj[col] = row[idx];
                    });
                    return obj;
                });
            }
            
            // ì´ˆê¸° ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ì„¤ì •
            const columnMap = {
                'YEAR': 'year',
                'MONTH': 'month',
                'ê³ ê°ëª…': 'customer',
                'ì§€ì—­1': 'region1',
                'ì§€ì—­2': 'region2',
                'ì§€ì—­3': 'region3',
                'ìƒí’ˆëª…': 'product'
            };
            
            Object.keys(columnMap).forEach(col => {
                const key = columnMap[col];
                options[key].clear();
                
                const colIndex = columns.indexOf(col);
                if (colIndex !== -1) {
                    rows.forEach(row => {
                        if (row[colIndex] && row[colIndex] !== '') {
                            options[key].add(row[colIndex]);
                        }
                    });
                }
            });
        }
        
        // ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
        updateDropdowns(tabName);
        
        // YEAR, MONTH ê¸°ë³¸ê°’ì„ "ì „ì²´"ë¡œ ì„¤ì •
        const prefix = tabName.toLowerCase();
        document.getElementById(`${prefix}-year`).value = '';
        document.getElementById(`${prefix}-month`).value = '';
        
    } catch (error) {
        console.error('ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ë¡œë“œ ì‹¤íŒ¨:', error);
        showStatus(`âŒ ${tabName} ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
    }
}

// ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
function updateDropdowns(tabName, specificDropdowns = null) {
    const prefix = tabName.toLowerCase();
    const options = tabName === 'ACE' ? aceDropdownOptions : essaDropdownOptions;
    
    const allDropdowns = {
        year: document.getElementById(`${prefix}-year`),
        month: document.getElementById(`${prefix}-month`),
        customer: document.getElementById(`${prefix}-customer`),
        region1: document.getElementById(`${prefix}-region1`),
        region2: document.getElementById(`${prefix}-region2`),
        region3: document.getElementById(`${prefix}-region3`),
        product: document.getElementById(`${prefix}-product`)
    };
    
    const dropdownsToUpdate = specificDropdowns || Object.keys(allDropdowns);
    
    dropdownsToUpdate.forEach(key => {
        const dropdown = allDropdowns[key];
        if (!dropdown) return;
        
        const currentValue = dropdown.value;
        
        // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì²« ë²ˆì§¸ "ì „ì²´" ì˜µì…˜ ì œì™¸)
        while (dropdown.options.length > 1) {
            dropdown.remove(1);
        }
        
        // ìƒˆ ì˜µì…˜ ì¶”ê°€
        const sortedOptions = Array.from(options[key]).sort((a, b) => {
            // ìˆ«ìì¸ ê²½ìš° ìˆ«ìë¡œ ì •ë ¬
            if (!isNaN(a) && !isNaN(b)) {
                return Number(a) - Number(b);
            }
            // ë¬¸ìì—´ì¸ ê²½ìš° ë¬¸ìì—´ë¡œ ì •ë ¬
            return String(a).localeCompare(String(b), 'ko');
        });
        
        sortedOptions.forEach(value => {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = value;
            dropdown.appendChild(option);
        });
        
        // ì´ì „ ì„ íƒê°’ ë³µì› ë˜ëŠ” YEAR/MONTHëŠ” "ì „ì²´"ë¡œ ê¸°ë³¸ ì„¤ì •
        if (currentValue && options[key].has(currentValue)) {
            dropdown.value = currentValue;
        } else if ((key === 'year' || key === 'month') && !currentValue) {
            dropdown.value = '';  // "ì „ì²´" ì„ íƒ
        }
    });
}

// YEAR/MONTH ë³€ê²½ ì‹œ ì¢…ì† ë°ì´í„° í•„í„°ë§
function handleYearMonthChange(tabName) {
    const prefix = tabName.toLowerCase();
    const allData = tabName === 'ACE' ? aceAllData : essaAllData;
    const options = tabName === 'ACE' ? aceDropdownOptions : essaDropdownOptions;
    
    const year = document.getElementById(`${prefix}-year`).value;
    const month = document.getElementById(`${prefix}-month`).value;
    
    // í•„í„°ë§ëœ ë°ì´í„°
    let filteredData = allData;
    
    if (year) {
        filteredData = filteredData.filter(row => row['YEAR'] == year);
    }
    if (month) {
        filteredData = filteredData.filter(row => row['MONTH'] == month);
    }
    
    // ì¢…ì† ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ì—…ë°ì´íŠ¸
    ['customer', 'region1', 'region2', 'region3', 'product'].forEach(key => {
        const colMap = {
            'customer': 'ê³ ê°ëª…',
            'region1': 'ì§€ì—­1',
            'region2': 'ì§€ì—­2',
            'region3': 'ì§€ì—­3',
            'product': 'ìƒí’ˆëª…'
        };
        
        options[key].clear();
        filteredData.forEach(row => {
            const value = row[colMap[key]];
            if (value && value !== '') {
                options[key].add(value);
            }
        });
    });
    
    // ë“œë¡­ë‹¤ìš´ UI ì—…ë°ì´íŠ¸
    updateDropdowns(tabName, ['customer', 'region1', 'region2', 'region3', 'product']);
}

// ì§€ì—­1 ë³€ê²½ ì‹œ ì§€ì—­2 í•„í„°ë§
function handleRegion1Change(tabName) {
    const prefix = tabName.toLowerCase();
    const allData = tabName === 'ACE' ? aceAllData : essaAllData;
    const options = tabName === 'ACE' ? aceDropdownOptions : essaDropdownOptions;
    
    const year = document.getElementById(`${prefix}-year`).value;
    const month = document.getElementById(`${prefix}-month`).value;
    const region1 = document.getElementById(`${prefix}-region1`).value;
    
    // í•„í„°ë§ëœ ë°ì´í„°
    let filteredData = allData;
    
    if (year) {
        filteredData = filteredData.filter(row => row['YEAR'] == year);
    }
    if (month) {
        filteredData = filteredData.filter(row => row['MONTH'] == month);
    }
    if (region1) {
        filteredData = filteredData.filter(row => row['ì§€ì—­1'] == region1);
    }
    
    // ì§€ì—­2, ì§€ì—­3 ì˜µì…˜ ì—…ë°ì´íŠ¸
    options.region2.clear();
    options.region3.clear();
    
    filteredData.forEach(row => {
        if (row['ì§€ì—­2'] && row['ì§€ì—­2'] !== '') {
            options.region2.add(row['ì§€ì—­2']);
        }
        if (row['ì§€ì—­3'] && row['ì§€ì—­3'] !== '') {
            options.region3.add(row['ì§€ì—­3']);
        }
    });
    
    // ë“œë¡­ë‹¤ìš´ UI ì—…ë°ì´íŠ¸
    updateDropdowns(tabName, ['region2', 'region3']);
    
    // ì§€ì—­2, ì§€ì—­3 ì„ íƒ ì´ˆê¸°í™”
    document.getElementById(`${prefix}-region2`).value = '';
    document.getElementById(`${prefix}-region3`).value = '';
}

// ì§€ì—­2 ë³€ê²½ ì‹œ ì§€ì—­3 í•„í„°ë§
function handleRegion2Change(tabName) {
    const prefix = tabName.toLowerCase();
    const allData = tabName === 'ACE' ? aceAllData : essaAllData;
    const options = tabName === 'ACE' ? aceDropdownOptions : essaDropdownOptions;
    
    const year = document.getElementById(`${prefix}-year`).value;
    const month = document.getElementById(`${prefix}-month`).value;
    const region1 = document.getElementById(`${prefix}-region1`).value;
    const region2 = document.getElementById(`${prefix}-region2`).value;
    
    // í•„í„°ë§ëœ ë°ì´í„°
    let filteredData = allData;
    
    if (year) {
        filteredData = filteredData.filter(row => row['YEAR'] == year);
    }
    if (month) {
        filteredData = filteredData.filter(row => row['MONTH'] == month);
    }
    if (region1) {
        filteredData = filteredData.filter(row => row['ì§€ì—­1'] == region1);
    }
    if (region2) {
        filteredData = filteredData.filter(row => row['ì§€ì—­2'] == region2);
    }
    
    // ì§€ì—­3 ì˜µì…˜ ì—…ë°ì´íŠ¸
    options.region3.clear();
    
    filteredData.forEach(row => {
        if (row['ì§€ì—­3'] && row['ì§€ì—­3'] !== '') {
            options.region3.add(row['ì§€ì—­3']);
        }
    });
    
    // ë“œë¡­ë‹¤ìš´ UI ì—…ë°ì´íŠ¸
    updateDropdowns(tabName, ['region3']);
    
    // ì§€ì—­3 ì„ íƒ ì´ˆê¸°í™”
    document.getElementById(`${prefix}-region3`).value = '';
}

// íƒ­ ì „í™˜
function switchTab(tabName) {
    currentTab = tabName;
    
    // íƒ­ ë²„íŠ¼ í™œì„±í™”
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent === tabName) {
            btn.classList.add('active');
        }
    });
    
    // íƒ­ ì»¨í…ì¸  í‘œì‹œ
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    if (tabName === 'ACE') {
        document.getElementById('ace-tab').classList.add('active');
    } else {
        document.getElementById('essa-tab').classList.add('active');
    }
}

// ê²€ìƒ‰ ì‹¤í–‰
function executeSearch(tabName) {
    if (!db) {
        showStatus('âš ï¸ ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”', 'error');
        return;
    }

    const tableName = `data_(${tabName})`;
    const prefix = tabName.toLowerCase();
    
    const year = document.getElementById(`${prefix}-year`).value.trim();
    const month = document.getElementById(`${prefix}-month`).value.trim();
    const customer = document.getElementById(`${prefix}-customer`).value.trim();
    const region1 = document.getElementById(`${prefix}-region1`).value.trim();
    const region2 = document.getElementById(`${prefix}-region2`).value.trim();
    const region3 = document.getElementById(`${prefix}-region3`).value.trim();
    const product = document.getElementById(`${prefix}-product`).value.trim();

    let query = `SELECT * FROM "${tableName}"`;
    let conditions = [];

    if (year) conditions.push(`"YEAR" = '${year}'`);
    if (month) conditions.push(`"MONTH" = '${month}'`);
    if (customer) conditions.push(`"ê³ ê°ëª…" = '${customer}'`);
    if (region1) conditions.push(`"ì§€ì—­1" = '${region1}'`);
    if (region2) conditions.push(`"ì§€ì—­2" = '${region2}'`);
    if (region3) conditions.push(`"ì§€ì—­3" = '${region3}'`);
    if (product) conditions.push(`"ìƒí’ˆëª…" = '${product}'`);

    if (conditions.length > 0) {
        query += ' WHERE ' + conditions.join(' AND ');
    }

    try {
        showStatus('ğŸ” ê²€ìƒ‰ ì¤‘...', 'loading');
        const result = db.exec(query);

        if (result.length > 0) {
            const columns = result[0].columns;
            const rows = result[0].values;

            if (tabName === 'ACE') {
                aceResults.columns = columns;
                aceResults.rows = rows;
                aceResults.currentPage = 1;
            } else {
                essaResults.columns = columns;
                essaResults.rows = rows;
                essaResults.currentPage = 1;
            }

            updateCustomerPurchaseHistory(columns, rows);
            displayResults(tabName);
            updatePagination(tabName);
            updateResultCount(tabName);
            updateExportInfo(tabName);
            showStatus(`âœ… ê²€ìƒ‰ ì™„ë£Œ: ${rows.length.toLocaleString()}ê°œ í–‰`, 'success');
        } else {
            if (tabName === 'ACE') {
                aceResults = { columns: [], rows: [], currentPage: 1, pageSize: 50 };
            } else {
                essaResults = { columns: [], rows: [], currentPage: 1, pageSize: 50 };
            }
            displayResults(tabName);
            updatePagination(tabName);
            updateResultCount(tabName);
            updateExportInfo(tabName);
            showStatus('âš ï¸ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
        }
    } catch (error) {
        showStatus('âŒ ê²€ìƒ‰ ì‹¤íŒ¨: ' + error.message, 'error');
        console.error('Query error:', error);
    }
}

// ê²€ìƒ‰ ì´ˆê¸°í™”
function clearSearch(tabName) {
    const prefix = tabName.toLowerCase();
    
    document.getElementById(`${prefix}-year`).value = '';
    document.getElementById(`${prefix}-month`).value = '';
    document.getElementById(`${prefix}-customer`).value = '';
    document.getElementById(`${prefix}-region1`).value = '';
    document.getElementById(`${prefix}-region2`).value = '';
    document.getElementById(`${prefix}-region3`).value = '';
    document.getElementById(`${prefix}-product`).value = '';
    
    // ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ë³µì›
    loadDropdownOptions(tabName);

    if (tabName === 'ACE') {
        aceResults = { columns: [], rows: [], currentPage: 1, pageSize: 50 };
    } else {
        essaResults = { columns: [], rows: [], currentPage: 1, pageSize: 50 };
    }

    displayResults(tabName);
    updatePagination(tabName);
    updateResultCount(tabName);
    updateExportInfo(tabName);
    
    showStatus('ğŸ”„ ê²€ìƒ‰ ì¡°ê±´ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
}

// ê³ ê°ë³„ êµ¬ë§¤ ì´ë ¥ ì—…ë°ì´íŠ¸
function updateCustomerPurchaseHistory(columns, rows) {
    customerPurchaseHistory.clear();
    
    const customerField = columns.find(col => col.includes('ê³ ê°') || col.includes('ì´ë¦„'));
    const dateField = columns.find(col => col.includes('íŒë§¤ì¼') || col.includes('ë‚ ì§œ'));
    
    if (!customerField || !dateField) return;
    
    const customerIndex = columns.indexOf(customerField);
    const dateIndex = columns.indexOf(dateField);
    
    rows.forEach(row => {
        const customerName = row[customerIndex];
        const dateValue = row[dateIndex];
        
        if (customerName && dateValue) {
            if (!customerPurchaseHistory.has(customerName)) {
                customerPurchaseHistory.set(customerName, []);
            }
            customerPurchaseHistory.get(customerName).push(dateValue);
        }
    });
    
    customerPurchaseHistory.forEach((dates, customer) => {
        dates.sort((a, b) => new Date(a) - new Date(b));
    });
}

// ì¬êµ¬ë§¤ ì •ë³´ í™•ì¸
function getRepurchaseInfo(customerName, currentDate) {
    if (!customerPurchaseHistory.has(customerName)) return null;
    
    const purchaseDates = customerPurchaseHistory.get(customerName);
    const currentDateObj = new Date(currentDate);
    
    const previousPurchases = purchaseDates.filter(date => {
        const dateObj = new Date(date);
        return dateObj < currentDateObj;
    });
    
    if (previousPurchases.length > 0) {
        const lastPurchase = previousPurchases[previousPurchases.length - 1];
        return {
            isRepurchase: true,
            lastPurchaseDate: lastPurchase,
            purchaseCount: previousPurchases.length + 1
        };
    }
    
    return null;
}

// ê²°ê³¼ í‘œì‹œ
function displayResults(tabName) {
    const results = tabName === 'ACE' ? aceResults : essaResults;
    const cardView = document.getElementById(`${tabName.toLowerCase()}-card-view`);
    
    if (results.rows.length === 0) {
        cardView.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 80px 20px; color: #64748b;">
                <div style="font-size: 4em; margin-bottom: 20px; opacity: 0.4;">ğŸ”</div>
                <div style="font-size: 1.2em; font-weight: 600;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            </div>
        `;
        return;
    }

    const startIndex = (results.currentPage - 1) * results.pageSize;
    const endIndex = Math.min(startIndex + results.pageSize, results.rows.length);
    
    const customerField = results.columns.find(col => col.includes('ê³ ê°') || col.includes('ì´ë¦„'));
    const dateField = results.columns.find(col => col.includes('íŒë§¤ì¼') || col.includes('ë‚ ì§œ'));
    
    if (customerField && dateField) {
        const customerDateGroups = {};
        
        for (let i = startIndex; i < endIndex; i++) {
            const row = results.rows[i];
            const customerName = row[results.columns.indexOf(customerField)];
            const dateValue = row[results.columns.indexOf(dateField)];
            const key = `${customerName}_${dateValue}` || 'ë¯¸ì§€ì •';
            
            if (!customerDateGroups[key]) {
                customerDateGroups[key] = [];
            }
            customerDateGroups[key].push({ row, index: i + 1 });
        }
        
        let html = '';
        Object.keys(customerDateGroups).forEach(key => {
            const records = customerDateGroups[key];
            const customerName = key.split('_')[0];
            html += createGroupedDataCard(results.columns, records, customerName);
        });
        
        cardView.innerHTML = html;
    } else {
        let html = '';
        for (let i = startIndex; i < endIndex; i++) {
            const row = results.rows[i];
            html += createSingleDataCard(results.columns, row, i + 1);
        }
        cardView.innerHTML = html;
    }
}

// ê·¸ë£¹í™”ëœ ì¹´ë“œ ìƒì„±
function createGroupedDataCard(columns, records, customerName) {
    const firstRecord = records[0].row;
    const dateField = columns.find(col => col.includes('íŒë§¤ì¼') || col.includes('ë‚ ì§œ'));
    const dateValue = dateField ? firstRecord[columns.indexOf(dateField)] : null;
    
    let repurchaseInfo = null;
    if (dateValue && customerName) {
        repurchaseInfo = getRepurchaseInfo(customerName, dateValue);
    }
    
    const sellerField = columns.find(col => col.includes('íŒë§¤ì') || col.includes('ë‹´ë‹¹ì'));
    const sellerValue = sellerField ? firstRecord[columns.indexOf(sellerField)] : null;
    
    const locationInfo = extractLocationInfo(columns, firstRecord);
    
    let cardHTML = `
        <div class="data-card">
            <div class="card-header">
                <div class="card-customer">
                    <div class="card-number">${records[0].index}.</div>
                    <div class="card-name">${customerName}</div>
                    ${locationInfo ? `<div class="card-location">${locationInfo}</div>` : ''}
                </div>
            </div>
            <div class="card-body">
    `;
    
    if (dateValue) {
        cardHTML += `
            <div class="card-section">
                <div class="card-content">
                    <span class="card-label">íŒë§¤ì¼:</span>
                    <span class="card-value">${formatDateForCard(dateValue, dateField)}</span>
                </div>
            </div>
        `;
    }
    
    if (repurchaseInfo && repurchaseInfo.isRepurchase) {
        cardHTML += `
            <div class="card-section">
                <div class="card-content">
                    <span class="card-label">ì¬êµ¬ë§¤:</span>
                    <span class="card-value repurchase">${repurchaseInfo.purchaseCount}ë²ˆì§¸ êµ¬ë§¤ (ì´ì „: ${formatDateForCard(repurchaseInfo.lastPurchaseDate, dateField)})</span>
                </div>
            </div>
        `;
    }
    
    if (sellerValue && sellerValue !== '-') {
        cardHTML += `
            <div class="card-section">
                <div class="card-content">
                    <span class="card-label">íŒë§¤ì:</span>
                    <span class="card-value seller">${formatCellValue(sellerValue, sellerField)}</span>
                </div>
            </div>
        `;
    }
    
    const deliveryDateInfo = getDeliveryDateInfo(columns, firstRecord);
    if (deliveryDateInfo) {
        cardHTML += `
            <div class="card-section">
                <div class="card-content">
                    <span class="card-label">ë°°ì†¡ì¼:</span>
                    <span class="card-value">${deliveryDateInfo}</span>
                </div>
            </div>
        `;
    }
    
    records.forEach((record) => {
        const row = record.row;
        
        const productInfo = formatProductInfo(columns, row);
        if (productInfo) {
            cardHTML += `
                <div class="card-section">
                    <div class="card-content">
                        <span class="card-label">ìƒí’ˆ:</span>
                        <span class="card-value product">${productInfo}</span>
                    </div>
                </div>
            `;
        }
        
        const purposeField = columns.find(col => col.includes('ìš©ë„') || col.includes('ëª©ì '));
        if (purposeField) {
            const purposeValue = row[columns.indexOf(purposeField)];
            if (purposeValue && purposeValue !== '-') {
                cardHTML += `
                    <div class="card-section">
                        <div class="card-content">
                            <span class="card-label">êµ¬ë§¤ìš©ë„:</span>
                            <span class="card-value">${formatCellValue(purposeValue, purposeField)}</span>
                        </div>
                    </div>
                `;
            }
        }
        
        const discountPriceField = columns.find(col => col.includes('í• ì¸ê°€') || col.includes('í• ì¸ê¸ˆì•¡'));
        const priceField = columns.find(col => (col.includes('ì¶œê³ ê°€') || col.includes('ê¸ˆì•¡') || col.includes('ê°€ê²©')) && !col.includes('í• ì¸'));
        const finalPriceField = discountPriceField || priceField;
        
        if (finalPriceField) {
            const priceValue = row[columns.indexOf(finalPriceField)];
            if (priceValue) {
                let priceText = formatCellValue(priceValue, finalPriceField) + 'ì›';
                
                if (discountPriceField) {
                    priceText += ' <span class="card-value discount">(í• ì¸ê°€)</span>';
                } else {
                    const discountRateField = columns.find(col => col.includes('í• ì¸ìœ¨') || col.includes('í• ì¸') || col.includes('D.C'));
                    if (discountRateField) {
                        const discountValue = row[columns.indexOf(discountRateField)];
                        if (discountValue && discountValue !== '-' && discountValue !== '0' && parseFloat(discountValue) !== 0) {
                            priceText += ' <span class="card-value discount">(í• ì¸ê°€)</span>';
                        }
                    }
                }
                
                cardHTML += `
                    <div class="card-section">
                        <div class="card-content">
                            <span class="card-label">ê¸ˆì•¡:</span>
                            <span class="card-value money">${priceText}</span>
                        </div>
                    </div>
                `;
            }
        }
        
        const allowedPaymentFields = columns.filter(col => {
            const colName = col;
            if (colName.includes('í˜„ê¸ˆì¦ë¹™') || colName.includes('í˜„ê¸ˆì˜ìˆ˜ì¦') || colName.includes('ì„¸ê¸ˆê³„ì‚°ì„œ') ||
                colName.includes('ì¹´ë“œìˆ˜ìˆ˜ë£Œ') || colName.includes('ìˆ˜ìˆ˜ë£Œ') ||
                colName.includes('ì¹´ë“œì‚¬') || colName.includes('í• ë¶€')) {
                return false;
            }
            return (colName.includes('ì¹´ë“œ') && !colName.includes('í˜•ìƒí’ˆê¶Œ') && !colName.includes('ì¹´ë“œí˜•') ||
                    colName.includes('í˜„ê¸ˆ') && !colName.includes('ì¦ë¹™') && !colName.includes('ì˜ìˆ˜ì¦') ||
                    colName.includes('QRê²°ì œ') || colName.includes('QR') && colName.includes('ê²°ì œ') ||
                    colName.includes('ì§€ì—­ìƒí’ˆê¶Œ') ||
                    colName.includes('ì¹´ë“œí˜•ìƒí’ˆê¶Œ'));
        });
        
        if (allowedPaymentFields.length > 0) {
            let paymentText = [];
            allowedPaymentFields.forEach(field => {
                const value = row[columns.indexOf(field)];
                if (value && value !== '-' && value !== '0' && parseFloat(value) !== 0) {
                    const formatted = formatCellValue(value, field);
                    let fieldName = field.replace('ê²°ì œ', '').trim();
                    paymentText.push(`${fieldName} ${formatted}ì›`);
                }
            });
            
            if (paymentText.length > 0) {
                cardHTML += `
                    <div class="card-section">
                        <div class="card-content">
                            <span class="card-label">ê²°ì œ:</span>
                            <span class="card-value">${paymentText.join(' + ')}</span>
                        </div>
                    </div>
                `;
            }
        }
        
        const discountRateField = columns.find(col => col.includes('í• ì¸ìœ¨') || col.includes('D.C') || col.includes('ìœ¨'));
        if (discountRateField) {
            const discountRateValue = row[columns.indexOf(discountRateField)];
            if (discountRateValue && discountRateValue !== '-' && discountRateValue !== '0') {
                const discountRate = formatCellValue(discountRateValue, discountRateField);
                cardHTML += `
                    <div class="card-section">
                        <div class="card-content">
                            <span class="card-label">í• ì¸ìœ¨:</span>
                            <span class="card-value discount-rate">${discountRate}</span>
                        </div>
                    </div>
                `;
            }
        }
        
        const giftInfo = formatGiftInfo(columns, row);
        if (giftInfo) {
            cardHTML += `
                <div class="card-section">
                    <div class="card-content">
                        <span class="card-label">ì‚¬ì€í’ˆ:</span>
                        <span class="card-value gift">${giftInfo}</span>
                    </div>
                </div>
            `;
        }
    });
    
    cardHTML += `
            </div>
        </div>
    `;
    
    return cardHTML;
}

// ë‹¨ì¼ ì¹´ë“œ ìƒì„±
function createSingleDataCard(columns, row, index) {
    const dateField = columns.find(col => col.includes('ë‚ ì§œ') || col.includes('ì¼'));
    const dateValue = dateField ? row[columns.indexOf(dateField)] : null;
    
    let cardHTML = `
        <div class="data-card">
            <div class="card-header">
                <div class="card-number">#${index}</div>
            </div>
            <div class="card-body">
    `;
    
    if (dateValue) {
        cardHTML += `
            <div class="card-section">
                <div class="card-content">
                    <span class="card-label">ë‚ ì§œ:</span>
                    <span class="card-value">${formatDateForCard(dateValue, dateField)}</span>
                </div>
            </div>
        `;
    }
    
    columns.forEach((col, colIndex) => {
        const value = row[colIndex];
        const formattedValue = formatCellValue(value, col);
        
        if (formattedValue && formattedValue !== '-' && col !== dateField) {
            const isMoneyField = col.includes('ê¸ˆì•¡') || col.includes('ê°€ê²©') || col.includes('ì¶œê³ ê°€');
            cardHTML += `
                <div class="card-section">
                    <div class="card-content">
                        <span class="card-label">${col}:</span>
                        <span class="card-value ${isMoneyField ? 'money' : ''}">${formattedValue}</span>
                    </div>
                </div>
            `;
        }
    });
    
    cardHTML += `
            </div>
        </div>
    `;
    
    return cardHTML;
}

// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
function extractLocationInfo(columns, row) {
    const addressPatterns = [/ì£¼ì†Œ|address|addr/i, /ì§€ì—­|region|area/i, /ë™|ì|ë©´|ë¦¬|dong|myeon|ri/i, /ì‹œ|êµ°|êµ¬|si|gun|gu/i, /ë„|do|province/i];
    let province = '';
    let city = '';
    let dong = '';
    
    const addressColumns = columns.filter(col => addressPatterns.some(pattern => pattern.test(col)));
    
    addressColumns.forEach(col => {
        const value = row[columns.indexOf(col)];
        if (value && value !== '-' && String(value).trim() !== '') {
            const addressText = String(value).trim();
            
            if (!province) {
                const provinceMatch = addressText.match(/(ì„œìš¸|ë¶€ì‚°|ëŒ€êµ¬|ì¸ì²œ|ê´‘ì£¼|ëŒ€ì „|ìš¸ì‚°|ì„¸ì¢…|ê²½ê¸°|ê°•ì›|ì¶©ë¶|ì¶©ë‚¨|ì „ë¶|ì „ë‚¨|ê²½ë¶|ê²½ë‚¨|ì œì£¼)(íŠ¹ë³„ì‹œ|ê´‘ì—­ì‹œ|ë„)?/);
                if (provinceMatch) {
                    province = provinceMatch[1];
                }
            }
            
            if (!city) {
                const cityMatch = addressText.match(/([ê°€-í£]+(ì‹œ|êµ°|êµ¬))(?!.*(ì‹œ|êµ°|êµ¬))/);
                if (cityMatch) {
                    city = cityMatch[1];
                }
            }
            
            if (!dong) {
                const dongMatch = addressText.match(/([ê°€-í£]+(ë™|ì|ë©´|ë¦¬))(?!.*(ë™|ì|ë©´|ë¦¬))/);
                if (dongMatch) {
                    dong = dongMatch[1];
                }
            }
        }
    });
    
    const locationParts = [];
    if (province) locationParts.push(province);
    if (city) locationParts.push(city);
    if (dong) locationParts.push(dong);
    
    return locationParts.length > 0 ? locationParts.join(' ') : null;
}

function getDeliveryDateInfo(columns, row) {
    const deliveryField = columns.find(col => col.includes('ë°°ì†¡ì¼') || col.includes('ì¶œê³ ì¼') || col.includes('ë‚©í’ˆì¼'));
    if (deliveryField) {
        const deliveryValue = row[columns.indexOf(deliveryField)];
        if (deliveryValue && deliveryValue !== '-') {
            return formatDateForCard(deliveryValue, deliveryField);
        }
    }
    return null;
}

function formatProductInfo(columns, row) {
    const productNameField = columns.find(col => col.includes('ìƒí’ˆ') || col.includes('ì œí’ˆ') || col.includes('í’ˆëª…'));
    const specField = columns.find(col => col.includes('ê·œê²©') || col.includes('ì‚¬ì´ì¦ˆ') || col.includes('size'));
    const gradeField = columns.find(col => col.includes('ë“±ê¸‰') || col.includes('í’ˆì§ˆ') || col.includes('grade'));
    const materialField = columns.find(col => col.includes('ì†Œì¬') || col.includes('ì¬ì§ˆ') || col.includes('material'));
    const colorField = columns.find(col => col.includes('ìƒ‰ìƒ') || col.includes('ì»¬ëŸ¬') || col.includes('color'));
    const quantityField = columns.find(col => col.includes('ìˆ˜ëŸ‰') || col.includes('ê°œìˆ˜') || col.includes('quantity'));
    
    const productParts = [];
    
    if (productNameField) {
        const productName = row[columns.indexOf(productNameField)];
        if (productName && productName !== '-') {
            productParts.push(formatCellValue(productName, productNameField));
        }
    }
    
    if (specField) {
        const spec = row[columns.indexOf(specField)];
        if (spec && spec !== '-') {
            productParts.push(formatCellValue(spec, specField));
        }
    }
    
    if (gradeField) {
        const grade = row[columns.indexOf(gradeField)];
        if (grade && grade !== '-') {
            productParts.push(formatCellValue(grade, gradeField));
        }
    }
    
    if (materialField) {
        const material = row[columns.indexOf(materialField)];
        if (material && material !== '-') {
            productParts.push(formatCellValue(material, materialField));
        }
    }
    
    if (colorField) {
        const color = row[columns.indexOf(colorField)];
        if (color && color !== '-') {
            productParts.push(formatCellValue(color, colorField));
        }
    }
    
    if (quantityField) {
        const quantity = row[columns.indexOf(quantityField)];
        if (quantity && quantity !== '-' && quantity !== '0') {
            const quantityValue = parseFloat(quantity);
            if (!isNaN(quantityValue)) {
                productParts.push(Math.round(quantityValue).toString() + 'ê°œ');
            } else {
                productParts.push(formatCellValue(quantity, quantityField));
            }
        }
    }
    
    return productParts.length > 0 ? productParts.join(' / ') : null;
}

function formatGiftInfo(columns, row) {
    const giftFields = columns.filter(col => 
        (col.includes('ì‚¬ì€í’ˆ') || col.includes('ì¦ì •') || col.includes('ì„ ë¬¼') || col.includes('í”„ë¡œëª¨ì…˜') || 
         col.includes('ì´ë²¤íŠ¸') || col.toLowerCase().includes('gift') || col.toLowerCase().includes('promotion') ||
         col.toLowerCase().includes('free') || col.includes('ë¬´ë£Œ')) &&
        !col.includes('ê¸ˆì•¡') && !col.includes('ê°€ê²©') && !col.includes('ë¹„ìš©') && !col.includes('ì›') && 
        !col.includes('ë¹„ìš©') && !col.includes('M/G')
    );
    
    const giftParts = [];
    giftFields.forEach(field => {
        const value = row[columns.indexOf(field)];
        if (value && value !== '-' && value !== '0' && String(value).trim() !== '') {
            const formattedValue = formatCellValue(value, field);
            if (!/^[\d,.\s]+ì›?$/.test(formattedValue) && !/^\d+$/.test(formattedValue)) {
                giftParts.push(formattedValue);
            }
        }
    });
    
    return giftParts.length > 0 ? giftParts.join(' / ') : null;
}

function formatDateForCard(value, columnName) {
    if (!value) return '';
    
    const stringValue = String(value).trim();
    
    const dateMatch = stringValue.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if (dateMatch) {
        const year = dateMatch[1];
        const month = parseInt(dateMatch[2]);
        const day = parseInt(dateMatch[3]);
        const date = new Date(year, month - 1, day);
        const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        const weekday = weekdays[date.getDay()];
        return `${year}ë…„ ${month}ì›” ${day}ì¼(${weekday})`;
    }
    
    if (stringValue.match(/^\d{8}$/)) {
        const year = stringValue.substring(0, 4);
        const month = parseInt(stringValue.substring(4, 6));
        const day = parseInt(stringValue.substring(6, 8));
        const date = new Date(year, month - 1, day);
        const weekdays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        const weekday = weekdays[date.getDay()];
        return `${year}ë…„ ${month}ì›” ${day}ì¼(${weekday})`;
    }
    
    if (stringValue.match(/^\d{4}-\d{2}$/)) {
        const year = stringValue.substring(0, 4);
        const month = parseInt(stringValue.substring(5, 7));
        return `${year}ë…„ ${month}ì›”`;
    }
    
    if (stringValue.match(/^\d{6}$/)) {
        const year = stringValue.substring(0, 4);
        const month = parseInt(stringValue.substring(4, 6));
        return `${year}ë…„ ${month}ì›”`;
    }
    
    return formatCellValue(value, columnName);
}

function formatCellValue(value, columnName) {
    if (value === null || value === undefined || value === '') {
        return '-';
    }
    
    const stringValue = String(value).trim();
    
    const dateColumns = ['íŒë§¤ì¼', 'ë°°ì†¡ì¼', 'ë‚ ì§œ', 'date', 'ì¶œê³ ì˜ˆì •ì¼', 'ë°°ì†¡ì˜ˆì •ì¼'];
    const isDateColumn = dateColumns.some(dateCol => columnName.includes(dateCol));
    
    if (isDateColumn) {
        if (stringValue.match(/^\d{4}-\d{2}-\d{2}/)) {
            return stringValue.split(' ')[0];
        }
        if (stringValue.match(/^\d{8}$/)) {
            return stringValue.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3');
        }
        if (stringValue.match(/^\d{6}$/)) {
            return stringValue.replace(/(\d{4})(\d{2})/, '$1-$2');
        }
    }
    
    if (columnName.includes('YEAR') || columnName === 'YEAR') {
        return stringValue;
    }
    
    if (columnName.includes('ìˆ˜ëŸ‰') || columnName.includes('ê°œìˆ˜') || columnName.includes('quantity') || columnName.includes('qty')) {
        if (!isNaN(stringValue) && stringValue !== '') {
            const numValue = parseFloat(stringValue);
            return Math.round(numValue).toString();
        }
    }
    
    if (columnName.includes('ê±´ìˆ˜') || columnName.includes('COUNT')) {
        if (!isNaN(stringValue) && stringValue !== '') {
            const numValue = parseFloat(stringValue);
            return numValue.toFixed(2);
        }
    }
    
    if (columnName.includes('D.C%') || columnName.includes('í• ì¸ìœ¨') || columnName.includes('ìœ¨')) {
        if (!isNaN(stringValue) && stringValue !== '') {
            const numValue = parseFloat(stringValue);
            if (!stringValue.includes('%')) {
                return (numValue * 100).toFixed(1) + '%';
            }
        }
        return stringValue;
    }
    
    const moneyColumns = ['ì¶œê³ ê°€', 'ê³µê¸‰ê°€', 'ë°°ì†¡ë¹„', 'ì‚¬ì€í’ˆë¹„', 'M/G', 'ê°€ê²©', 'ê¸ˆì•¡', 'ë¹„ìš©'];
    const isMoneyColumn = moneyColumns.some(moneyCol => columnName.includes(moneyCol));
    
    if (isMoneyColumn && !isNaN(stringValue) && stringValue !== '') {
        const numValue = parseFloat(stringValue);
        if (Number.isInteger(numValue)) {
            return numValue.toLocaleString();
        } else {
            return numValue.toLocaleString(undefined, {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }
    }
    
    if (!isNaN(stringValue) && stringValue !== '') {
        const numValue = parseFloat(stringValue);
        if (numValue >= 0 && numValue <= 1 && stringValue.includes('.')) {
            const decimalPlaces = stringValue.split('.')[1].length;
            if (decimalPlaces >= 2) {
                return (numValue * 100).toFixed(1) + '%';
            }
        }
        if (Number.isInteger(numValue)) {
            return numValue.toLocaleString();
        } else {
            return numValue.toFixed(Math.min(2, stringValue.split('.')[1].length));
        }
    }
    
    return stringValue;
}

// í˜ì´ì§€ë„¤ì´ì…˜
function updatePagination(tabName) {
    const results = tabName === 'ACE' ? aceResults : essaResults;
    const totalPages = Math.ceil(results.rows.length / results.pageSize);
    const prefix = tabName.toLowerCase();
    
    document.getElementById(`${prefix}-page-info`).textContent = `${results.currentPage} / ${totalPages} í˜ì´ì§€`;
    document.getElementById(`${prefix}-prev-btn`).disabled = results.currentPage === 1;
    document.getElementById(`${prefix}-next-btn`).disabled = results.currentPage === totalPages || totalPages === 0;
}

function previousPage(tabName) {
    const results = tabName === 'ACE' ? aceResults : essaResults;
    
    if (results.currentPage > 1) {
        results.currentPage--;
        displayResults(tabName);
        updatePagination(tabName);
    }
}

function nextPage(tabName) {
    const results = tabName === 'ACE' ? aceResults : essaResults;
    const totalPages = Math.ceil(results.rows.length / results.pageSize);
    
    if (results.currentPage < totalPages) {
        results.currentPage++;
        displayResults(tabName);
        updatePagination(tabName);
    }
}

// ê²°ê³¼ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
function updateResultCount(tabName) {
    const results = tabName === 'ACE' ? aceResults : essaResults;
    const resultCountElement = document.getElementById(`${tabName.toLowerCase()}-result-count`);
    
    if (results.rows.length > 0) {
        resultCountElement.textContent = `(${results.rows.length.toLocaleString()}ê°œ í–‰)`;
    } else {
        resultCountElement.textContent = '';
    }
}

// ë‚´ë³´ë‚´ê¸° ì •ë³´ ì—…ë°ì´íŠ¸
function updateExportInfo(tabName) {
    const results = tabName === 'ACE' ? aceResults : essaResults;
    const exportInfo = document.getElementById(`${tabName.toLowerCase()}-export-info`);
    
    if (results.rows.length > 0) {
        exportInfo.textContent = `í˜„ì¬ ${results.rows.length.toLocaleString()}ê°œ í–‰ì˜ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë‚´ë³´ëƒ…ë‹ˆë‹¤`;
    } else {
        exportInfo.textContent = 'í˜„ì¬ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë‚´ë³´ëƒ…ë‹ˆë‹¤';
    }
}

// Excel ë‚´ë³´ë‚´ê¸°
function exportToExcel(tabName) {
    const results = tabName === 'ACE' ? aceResults : essaResults;
    
    if (results.rows.length === 0) {
        showStatus('âš ï¸ ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
        return;
    }
    
    try {
        const columns = results.columns;
        const rows = results.rows;
        
        const wsData = [columns];
        rows.forEach(row => {
            const rowData = columns.map((col, index) => {
                const cell = row[index];
                return formatCellValue(cell, col);
            });
            wsData.push(rowData);
        });
        
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        
        const colWidths = columns.map((col, index) => {
            const maxLength = Math.max(
                col.length,
                ...rows.map(row => {
                    const cell = row[index];
                    return String(formatCellValue(cell, col)).length;
                })
            );
            return { width: Math.min(Math.max(maxLength, 8), 50) };
        });
        
        ws['!cols'] = colWidths;
        
        XLSX.utils.book_append_sheet(wb, ws, tabName);
        
        const fileName = `${tabName}_ê²€ìƒ‰ê²°ê³¼_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        showStatus(`âœ… ê²€ìƒ‰ ê²°ê³¼ ${rows.length.toLocaleString()}ê°œ í–‰ì„ Excelë¡œ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤`, 'success');
    } catch (error) {
        showStatus('âŒ Excel ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ' + error.message, 'error');
    }
}

// ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
function showStatus(message, type) {
    const statusArea = document.getElementById('status-area');
    statusArea.innerHTML = `<div class="status ${type}">${message}</div>`;
    
    if (type !== 'error' && type !== 'loading') {
        setTimeout(() => {
            statusArea.innerHTML = '';
        }, 3000);
    }
}
</script>
</body>
</html>
