<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•„íŒŒíŠ¸ ì‹œì„¸ ì¡°íšŒ - ë¡œì»¬ ë°ì´í„°ë² ì´ìŠ¤</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .database-info {
            background-color: #34495e;
            padding: 15px;
            margin-top: 10px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .file-section {
            background-color: #e74c3c;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: white;
        }
        
        .search-section {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        
        .search-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }
        
        .form-group {
            flex: 1;
            min-width: 180px;
        }
        
        .address-group {
            display: flex;
            gap: 10px;
            flex: 2;
        }
        
        .address-group .form-group {
            flex: 1;
        }
        
        .date-group {
            display: flex;
            gap: 10px;
            flex: 2;
            align-items: flex-end;
        }
        
        .date-group .form-group {
            flex: 1;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .action-buttons button {
            flex: 1;
            min-width: 120px;
        }
        
        .btn-excel {
            background-color: #27ae60;
        }
        
        .btn-excel:hover {
            background-color: #219a52;
        }
        
        .btn-view-all {
            background-color: #9b59b6;
        }
        
        .btn-view-all:hover {
            background-color: #8e44ad;
        }
        
        .btn-graph {
            background-color: #e67e22;
        }
        
        .btn-graph:hover {
            background-color: #d35400;
        }
        
        .results-section {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        
        .table-container {
            overflow-x: auto;
            max-height: 70vh;
            overflow-y: auto;
            position: relative;
        }
        
        .table-scroll-info {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            padding: 8px 15px;
            font-size: 0.8rem;
            color: #666;
            border-bottom: 1px solid #eee;
            text-align: center;
            z-index: 20;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 100%;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
            white-space: nowrap;
            position: relative;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #555;
            position: sticky;
            top: 40px;
            z-index: 10;
        }
        
        th:first-child, td:first-child {
            position: sticky;
            left: 0;
            background-color: #f8f9fa;
            z-index: 5;
            box-shadow: 1px 0 0 #eee;
        }
        
        th:first-child {
            z-index: 15;
        }
        
        tr:hover td {
            background-color: #f9f9f9;
        }
        
        tr:hover td:first-child {
            background-color: #f0f0f0;
        }
        
        .graph-section {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 30px;
            display: none;
        }
        
        .graph-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .graph-controls select {
            flex: 1;
            min-width: 200px;
        }
        
        .graph-container {
            position: relative;
            height: 500px;
            width: 100%;
        }
        
        .no-results {
            padding: 30px;
            text-align: center;
            color: #777;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        
        .error {
            background-color: #ffeaa7;
            color: #d63031;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            padding: 20px;
            gap: 10px;
        }
        
        .pagination button {
            background-color: #ecf0f1;
            color: #2c3e50;
            border: 1px solid #bdc3c7;
        }
        
        .pagination button.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .stats {
            background-color: #e8f4fc;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .file-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .file-input-wrapper input[type="file"] {
            flex: 1;
        }
        
        .column-mapping {
            background-color: #d5edff;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            font-size: 0.85rem;
        }
        
        .search-example {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }
        
        .contract-date {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .date-range-label {
            text-align: center;
            padding: 0 10px;
            color: #666;
            font-weight: bold;
        }
        
        .graph-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        
        .price-per-area {
            font-weight: bold;
            color: #e74c3c;
        }
        
        .scroll-hint {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(52, 152, 219, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            animation: bounce 2s infinite;
            z-index: 100;
        }

        .highlight-info {
            background-color: #e8f6f3;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            border-left: 4px solid #27ae60;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(-50%);
            }
            40% {
                transform: translateY(-60%);
            }
            60% {
                transform: translateY(-55%);
            }
        }
        
        @media (max-width: 768px) {
            .form-group {
                min-width: 100%;
            }
            
            .address-group {
                flex-direction: column;
            }
            
            .date-group {
                flex-direction: column;
            }
            
            .date-range-label {
                padding: 10px 0;
            }
            
            th, td {
                padding: 8px 10px;
                font-size: 0.9rem;
            }
            
            .file-input-wrapper {
                flex-direction: column;
            }
            
            .table-container {
                max-height: 60vh;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .stats {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .graph-container {
                height: 300px;
            }
            
            .graph-controls {
                flex-direction: column;
            }
            
            .scroll-hint {
                display: none;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>ì•„íŒŒíŠ¸ ì‹œì„¸ ì¡°íšŒ - ë¡œì»¬ ë°ì´í„°ë² ì´ìŠ¤</h1>
            <p style="text-align: center;">SQLite ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ì„ ì„ íƒí•˜ì—¬ ì•„íŒŒíŠ¸ ì‹¤ê±°ë˜ê°€ë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”</p>
            <div class="database-info" id="database-info">
                ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”...
            </div>
        </div>
    </header>
    
    <div class="container">
        <section class="file-section">
            <h3>ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ ì„ íƒ</h3>
            <div class="file-input-wrapper">
                <input type="file" id="db-file" accept=".db,.sqlite,.sqlite3">
                <button type="button" id="load-db-btn" disabled>ë°ì´í„°ë² ì´ìŠ¤ ë¡œë“œ</button>
            </div>
            <p style="margin-top: 10px; font-size: 0.9rem;">
                <strong>ê¸°ë³¸ ê²½ë¡œ:</strong> C:\Users\3vict\Dropbox\data\python\3.ì•„íŒŒíŠ¸ì‹œì„¸\sample_5.db
            </p>
        </section>
        
        <div class="error" id="error-message"></div>
        
        <section class="search-section" id="search-section" style="display: none;">
            <div class="column-mapping" id="column-mapping-info">
                ì»¬ëŸ¼ ë§¤í•‘ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...
            </div>
            
            <form class="search-form" id="search-form">
                <div class="address-group">
                    <div class="form-group">
                        <label for="address1">ì‹œ/ë„</label>
                        <input type="text" id="address1" placeholder="ì˜ˆ: ì„œìš¸, ê²½ê¸°, ë¶€ì‚°">
                        <div class="search-example">ì‹œ/ë„ ë‹¨ìœ„ë¡œ ê²€ìƒ‰</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="address2">ì‹œ/êµ°/êµ¬</label>
                        <input type="text" id="address2" placeholder="ì˜ˆ: ê°•ë‚¨êµ¬, ì„œì´ˆêµ¬, ì¢…ë¡œêµ¬">
                        <div class="search-example">ì‹œ/êµ°/êµ¬ ë‹¨ìœ„ë¡œ ê²€ìƒ‰</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="address3">ì/ë©´/ë™</label>
                        <input type="text" id="address3" placeholder="ì˜ˆ: ì‚¼ì„±ë™, ë°˜í¬ë™, ì‹ ë¦¼ë™">
                        <div class="search-example">ì/ë©´/ë™ ë‹¨ìœ„ë¡œ ê²€ìƒ‰</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="apt-name">ì•„íŒŒíŠ¸ëª…</label>
                    <input type="text" id="apt-name" placeholder="ì˜ˆ: ë˜ë¯¸ì•ˆ, ìì´, í‘¸ë¥´ì§€ì˜¤">
                    <div class="search-example">ì•„íŒŒíŠ¸ëª…ì— í¬í•¨ëœ ë‹¨ì–´ë¡œ ê²€ìƒ‰</div>
                </div>
                
                <div class="date-group">
                    <div class="form-group">
                        <label for="contract-year-from">ê³„ì•½ë…„ì›” ì‹œì‘</label>
                        <input type="month" id="contract-year-from" placeholder="YYYY-MM">
                        <div class="search-example">ì˜ˆ: 2024-01</div>
                    </div>
                    
                    <div class="date-range-label">~</div>
                    
                    <div class="form-group">
                        <label for="contract-year-to">ê³„ì•½ë…„ì›” ì¢…ë£Œ</label>
                        <input type="month" id="contract-year-to" placeholder="YYYY-MM">
                        <div class="search-example">ì˜ˆ: 2024-12</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="min-price">ìµœì†Œ ê°€ê²©</label>
                    <input type="number" id="min-price" placeholder="0">
                </div>
                
                <div class="form-group">
                    <label for="max-price">ìµœëŒ€ ê°€ê²©</label>
                    <input type="number" id="max-price" placeholder="100000">
                </div>
                
                <div class="form-group">
                    <button type="submit">ê²€ìƒ‰</button>
                    <button type="button" id="reset-btn" style="background-color: #95a5a6; margin-left: 10px;">ì´ˆê¸°í™”</button>
                </div>
            </form>
            
            <div class="action-buttons">
                <button type="button" id="show-all-btn" class="btn-view-all">ì „ì²´ ë°ì´í„° ë³´ê¸°</button>
                <button type="button" id="export-excel-btn" class="btn-excel">ì—‘ì…€ë¡œ ì €ì¥</button>
                <button type="button" id="show-graph-btn" class="btn-graph">ê·¸ë˜í”„ ë³´ê¸°</button>
            </div>
        </section>
        
        <section class="results-section">
            <div class="stats" id="stats" style="display: none;">
                <div>
                    ì´ <strong id="total-count">0</strong>ê°œ ì¤‘ <strong id="display-count">0</strong>ê°œ í‘œì‹œ
                </div>
                <div>
                    <small>ê°€ë¡œ ìŠ¤í¬ë¡¤ë¡œ ëª¨ë“  ì»¬ëŸ¼ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</small>
                </div>
            </div>
            
            <div class="loading" id="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            <div id="results-container">
                <div class="no-results" id="no-results">
                    ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”.
                </div>
                <div class="table-container" id="table-container" style="display: none;">
                    <div class="table-scroll-info">
                        â†¹ í…Œì´ë¸”ì„ ì¢Œìš°ë¡œ ìŠ¤í¬ë¡¤í•˜ì—¬ ëª¨ë“  ì»¬ëŸ¼ì„ í™•ì¸í•˜ì„¸ìš”
                    </div>
                    <div class="scroll-hint" id="scroll-hint">â†’ ìŠ¤í¬ë¡¤</div>
                    <table id="results-table">
                        <thead>
                            <tr id="table-headers">
                                <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
                            </tr>
                        </thead>
                        <tbody id="results-body">
                            <!-- ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="pagination" style="display: none;">
                    <!-- í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </section>
        
        <section class="graph-section" id="graph-section">
            <h3>ì›”ë³„ ì•„íŒŒíŠ¸ í‰ê·  í‰ë‹¨ê°€(3.3ã¡ ê¸°ì¤€)</h3>
            <div class="graph-info">
                <strong>ê·¸ë˜í”„ ì„¤ëª…:</strong> ê²€ìƒ‰ ê²°ê³¼ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì•„íŒŒíŠ¸ë³„ ì›”ë³„ í‰ê·  í‰ë‹¨ê°€ë¥¼ ì‹œê°í™”í•©ë‹ˆë‹¤.
                í‰ë‹¨ê°€(T) ì»¬ëŸ¼ì˜ ì›”ë³„ í‰ê· ê°’ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤ (3.3ã¡ ê¸°ì¤€). ì•„íŒŒíŠ¸ì™€ ê¸°ê°„ì„ ì„ íƒí•˜ì—¬ ë¹„êµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
            
            <div class="highlight-info" id="highlight-info" style="display: none;">
                <!-- ìµœê³ ê°€/ìµœì €ê°€ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
            
            <div class="graph-controls">
                <div class="form-group">
                    <label for="graph-apartment-select">ì•„íŒŒíŠ¸ ì„ íƒ</label>
                    <select id="graph-apartment-select" multiple>
                        <!-- ì•„íŒŒíŠ¸ ëª©ë¡ì´ ë™ì ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤ -->
                    </select>
                    <div class="search-example">Ctrl+í´ë¦­ìœ¼ë¡œ ì—¬ëŸ¬ ì•„íŒŒíŠ¸ ì„ íƒ ê°€ëŠ¥</div>
                </div>
                
                <div class="form-group">
                    <label for="graph-period-select">ê¸°ê°„ ì„ íƒ</label>
                    <select id="graph-period-select">
                        <option value="3">ìµœê·¼ 3ê°œì›”</option>
                        <option value="6">ìµœê·¼ 6ê°œì›”</option>
                        <option value="12">ìµœê·¼ 1ë…„</option>
                        <option value="all">ì „ì²´ ê¸°ê°„</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="graph-type-select">ê·¸ë˜í”„ ìœ í˜•</label>
                    <select id="graph-type-select">
                        <option value="line">ì„  ê·¸ë˜í”„</option>
                        <option value="bar">ë§‰ëŒ€ ê·¸ë˜í”„</option>
                    </select>
                </div>
                
                <button type="button" id="update-graph-btn" style="margin-top: 25px;">ê·¸ë˜í”„ ì—…ë°ì´íŠ¸</button>
            </div>
            
            <div class="graph-container">
                <canvas id="price-chart"></canvas>
            </div>
            
            <div class="graph-info" id="graph-data-info" style="display: none;">
                <!-- ê·¸ë˜í”„ ë°ì´í„° ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </section>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentPage = 1;
        const itemsPerPage = 50;
        let totalItems = 0;
        let currentData = [];
        let allSearchData = []; // ì „ì²´ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì €ì¥í•˜ëŠ” ë³€ìˆ˜ ì¶”ê°€
        let db = null;
        let tableInfo = null;
        let columnMapping = {};
        let allData = [];
        let priceChart = null;

        // SQL.js ì´ˆê¸°í™”
        let SQL;
        initSqlJs({
            locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
        }).then(function(sql) {
            SQL = sql;
            console.log("SQL.js ë¡œë“œ ì™„ë£Œ");
            
            // í˜„ì¬ ë‚ ì§œë¡œ ê¸°ë³¸ê°’ ì„¤ì •
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = String(now.getMonth() + 1).padStart(2, '0');
            const currentYearMonth = `${currentYear}-${currentMonth}`;
            
            // 1ë…„ ì „ ê³„ì‚°
            const oneYearAgo = new Date(now);
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            const oneYearAgoMonth = String(oneYearAgo.getMonth() + 1).padStart(2, '0');
            const oneYearAgoYearMonth = `${oneYearAgo.getFullYear()}-${oneYearAgoMonth}`;
            
            // ê¸°ë³¸ê°’ ì„¤ì •
            document.getElementById('contract-year-from').value = oneYearAgoYearMonth;
            document.getElementById('contract-year-to').value = currentYearMonth;
            
        }).catch(function(error) {
            console.error("SQL.js ë¡œë“œ ì‹¤íŒ¨:", error);
            showError('SQL.js ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
        });

        // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸
        document.getElementById('db-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('load-db-btn').disabled = false;
            }
        });

        // ë°ì´í„°ë² ì´ìŠ¤ ë¡œë“œ ë²„íŠ¼
        document.getElementById('load-db-btn').addEventListener('click', loadDatabase);

        // ê²€ìƒ‰ í¼ ì œì¶œ
        document.getElementById('search-form').addEventListener('submit', function(e) {
            e.preventDefault();
            currentPage = 1;
            searchAptData();
        });

        // ì´ˆê¸°í™” ë²„íŠ¼
        document.getElementById('reset-btn').addEventListener('click', function() {
            document.getElementById('search-form').reset();
            
            // ê³„ì•½ë…„ì›” ê¸°ë³¸ê°’ ì¬ì„¤ì •
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = String(now.getMonth() + 1).padStart(2, '0');
            const currentYearMonth = `${currentYear}-${currentMonth}`;
            
            const oneYearAgo = new Date(now);
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            const oneYearAgoMonth = String(oneYearAgo.getMonth() + 1).padStart(2, '0');
            const oneYearAgoYearMonth = `${oneYearAgo.getFullYear()}-${oneYearAgoMonth}`;
            
            document.getElementById('contract-year-from').value = oneYearAgoYearMonth;
            document.getElementById('contract-year-to').value = currentYearMonth;
            
            currentPage = 1;
            searchAptData();
        });

        // ì „ì²´ ë°ì´í„° ë³´ê¸° ë²„íŠ¼
        document.getElementById('show-all-btn').addEventListener('click', function() {
            document.getElementById('search-form').reset();
            currentPage = 1;
            loadAllData();
        });

        // ì—‘ì…€ ì €ì¥ ë²„íŠ¼
        document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);

        // ê·¸ë˜í”„ ë³´ê¸° ë²„íŠ¼
        document.getElementById('show-graph-btn').addEventListener('click', function() {
            if (!allSearchData || allSearchData.values.length === 0) {
                showError('ê·¸ë˜í”„ë¥¼ í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ê²€ìƒ‰ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
                return;
            }
            document.getElementById('graph-section').style.display = 'block';
            updateApartmentList();
            updateGraph();
        });

        // ê·¸ë˜í”„ ì—…ë°ì´íŠ¸ ë²„íŠ¼
        document.getElementById('update-graph-btn').addEventListener('click', updateGraph);

        // ìŠ¤í¬ë¡¤ íŒíŠ¸ ì œê±° í•¨ìˆ˜
        function hideScrollHint() {
            const scrollHint = document.getElementById('scroll-hint');
            if (scrollHint) {
                scrollHint.style.display = 'none';
            }
        }

        // í…Œì´ë¸” ì»¨í…Œì´ë„ˆ ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸
        document.addEventListener('DOMContentLoaded', function() {
            const tableContainer = document.getElementById('table-container');
            if (tableContainer) {
                tableContainer.addEventListener('scroll', hideScrollHint);
            }
        });

        // ê³„ì•½ë…„ì›”ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
        function formatContractDate(dateValue) {
            if (!dateValue) return '-';
            
            const dateStr = dateValue.toString();
            
            // YYYYMMDD í˜•ì‹ì¸ ê²½ìš°
            if (dateStr.length === 8 && /^\d+$/.test(dateStr)) {
                const year = dateStr.substring(0, 4);
                const month = dateStr.substring(4, 6);
                const day = dateStr.substring(6, 8);
                return `${year}ë…„ ${month}ì›” ${day}ì¼`;
            }
            
            // YYYY-MM-DD í˜•ì‹ì¸ ê²½ìš°
            if (dateStr.length === 10 && dateStr.includes('-')) {
                const [year, month, day] = dateStr.split('-');
                return `${year}ë…„ ${month}ì›” ${day}ì¼`;
            }
            
            // YYYYMM í˜•ì‹ì¸ ê²½ìš°
            if (dateStr.length === 6 && /^\d+$/.test(dateStr)) {
                const year = dateStr.substring(0, 4);
                const month = dateStr.substring(4, 6);
                return `${year}ë…„ ${month}ì›”`;
            }
            
            // ê·¸ ì™¸ì˜ ê²½ìš° ì›ë³¸ ê°’ ë°˜í™˜
            return dateValue;
        }

        // ì•„íŒŒíŠ¸ ëª©ë¡ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ - ì „ì²´ ê²€ìƒ‰ ê²°ê³¼ ì‚¬ìš©
        function updateApartmentList() {
            if (!allSearchData || !columnMapping.apartment) return;
            
            const apartmentSelect = document.getElementById('graph-apartment-select');
            apartmentSelect.innerHTML = '';
            
            // ì•„íŒŒíŠ¸ëª… ì»¬ëŸ¼ ì¸ë±ìŠ¤ ì°¾ê¸°
            const apartmentColumnIndex = allSearchData.columns.findIndex(col => 
                columnMapping.apartment === col
            );
            
            if (apartmentColumnIndex === -1) return;
            
            // ê³ ìœ í•œ ì•„íŒŒíŠ¸ëª… ì¶”ì¶œ (ì „ì²´ ê²€ìƒ‰ ê²°ê³¼ì—ì„œ)
            const apartments = new Set();
            allSearchData.values.forEach(row => {
                const apartmentName = row[apartmentColumnIndex];
                if (apartmentName) {
                    apartments.add(apartmentName);
                }
            });
            
            // ì•„íŒŒíŠ¸ ëª©ë¡ ì •ë ¬ ë° ì¶”ê°€
            const sortedApartments = Array.from(apartments).sort();
            sortedApartments.forEach(apartment => {
                const option = document.createElement('option');
                option.value = apartment;
                option.textContent = apartment;
                apartmentSelect.appendChild(option);
            });
            
            // ê¸°ë³¸ì ìœ¼ë¡œ ì²˜ìŒ 3ê°œ ì•„íŒŒíŠ¸ ì„ íƒ
            const options = apartmentSelect.options;
            for (let i = 0; i < Math.min(3, options.length); i++) {
                options[i].selected = true;
            }
        }

        // ì›”ë³„ í‰ê·  í‰ë‹¨ê°€ ê³„ì‚° í•¨ìˆ˜ - ì „ì²´ ê²€ìƒ‰ ê²°ê³¼ ì‚¬ìš©
        function calculateMonthlyAveragePricePerArea() {
            if (!allSearchData || !columnMapping.apartment || !columnMapping.date || !columnMapping.pricePerArea) {
                return null;
            }
            
            // ì»¬ëŸ¼ ì¸ë±ìŠ¤ ì°¾ê¸° (ì „ì²´ ê²€ìƒ‰ ê²°ê³¼ì˜ ì»¬ëŸ¼ ë°°ì—´ ì‚¬ìš©)
            const apartmentColumnIndex = allSearchData.columns.findIndex(col => 
                columnMapping.apartment === col
            );
            const dateColumnIndex = allSearchData.columns.findIndex(col => 
                columnMapping.date === col
            );
            const pricePerAreaColumnIndex = allSearchData.columns.findIndex(col => 
                columnMapping.pricePerArea === col
            );
            
            if (apartmentColumnIndex === -1 || dateColumnIndex === -1 || pricePerAreaColumnIndex === -1) {
                return null;
            }
            
            // ì„ íƒëœ ì•„íŒŒíŠ¸ë“¤
            const selectedApartments = Array.from(document.getElementById('graph-apartment-select').selectedOptions)
                .map(option => option.value);
            
            if (selectedApartments.length === 0) {
                return null;
            }
            
            // ë°ì´í„° ê·¸ë£¹í™”: ì•„íŒŒíŠ¸ë³„ ì›”ë³„ ë°ì´í„° (ì „ì²´ ê²€ìƒ‰ ê²°ê³¼ ì‚¬ìš©)
            const apartmentMonthlyData = {};
            
            allSearchData.values.forEach(row => {
                const apartment = row[apartmentColumnIndex];
                const dateValue = row[dateColumnIndex];
                const pricePerArea = parseFloat(row[pricePerAreaColumnIndex]);
                
                if (!apartment || !dateValue || isNaN(pricePerArea)) return;
                
                // ì„ íƒëœ ì•„íŒŒíŠ¸ë§Œ ì²˜ë¦¬
                if (!selectedApartments.includes(apartment)) return;
                
                // ë‚ ì§œì—ì„œ YYYYMM í˜•ì‹ ì¶”ì¶œ
                let yearMonth;
                const dateStr = dateValue.toString();
                
                if (dateStr.length === 8 && /^\d+$/.test(dateStr)) {
                    yearMonth = dateStr.substring(0, 6);
                } else if (dateStr.length === 10 && dateStr.includes('-')) {
                    yearMonth = dateStr.replace(/-/g, '').substring(0, 6);
                } else if (dateStr.length === 6 && /^\d+$/.test(dateStr)) {
                    yearMonth = dateStr;
                } else {
                    return;
                }
                
                if (!apartmentMonthlyData[apartment]) {
                    apartmentMonthlyData[apartment] = {};
                }
                
                if (!apartmentMonthlyData[apartment][yearMonth]) {
                    apartmentMonthlyData[apartment][yearMonth] = {
                        totalPricePerArea: 0,
                        transactionCount: 0
                    };
                }
                
                // ì›”ë³„ í‰ë‹¨ê°€ í•©ê³„ ëˆ„ì 
                apartmentMonthlyData[apartment][yearMonth].totalPricePerArea += pricePerArea;
                apartmentMonthlyData[apartment][yearMonth].transactionCount += 1;
            });
            
            // ì›”ë³„ í‰ê·  í‰ë‹¨ê°€ ê³„ì‚°
            const monthlyAverageData = {};
            const allMonths = new Set();
            
            Object.keys(apartmentMonthlyData).forEach(apartment => {
                monthlyAverageData[apartment] = {};
                Object.keys(apartmentMonthlyData[apartment]).forEach(month => {
                    const monthlyData = apartmentMonthlyData[apartment][month];
                    // ì›”ë³„ í‰ê·  í‰ë‹¨ê°€ = ì›”ë³„ í‰ë‹¨ê°€ í•©ê³„ / ì›”ë³„ ê±°ë˜ ê±´ìˆ˜
                    const avgPricePerArea = monthlyData.totalPricePerArea / monthlyData.transactionCount;
                    monthlyAverageData[apartment][month] = Math.round(avgPricePerArea);
                    allMonths.add(month);
                });
            });
            
            // ì›” ì •ë ¬
            const sortedMonths = Array.from(allMonths).sort();
            
            // ê¸°ê°„ í•„í„°ë§
            const period = document.getElementById('graph-period-select').value;
            let filteredMonths = sortedMonths;
            
            if (period !== 'all') {
                const monthsToShow = parseInt(period);
                filteredMonths = sortedMonths.slice(-monthsToShow);
            }
            
            // ë ˆì´ë¸” í¬ë§·íŒ… (23ë…„ 01ì›” / 24ë…„ 12ì›” í˜•ì‹)
            const labels = filteredMonths.map(month => {
                const year = month.substring(0, 4);
                const monthNum = month.substring(4, 6);
                // 4ìë¦¬ ì—°ë…„ì—ì„œ ë’¤ì˜ 2ìë¦¬ë§Œ ì‚¬ìš© (2023 â†’ 23ë…„)
                const shortYear = year.substring(2);
                return `${shortYear}ë…„ ${monthNum}ì›”`;
            });
            
            // ë°ì´í„°ì…‹ ìƒì„± ë° ìµœê³ ê°€/ìµœì €ê°€ ê³„ì‚°
            const datasets = [];
            const colors = [
                '#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6',
                '#1abc9c', '#d35400', '#c0392b', '#16a085', '#8e44ad'
            ];
            
            const highlightData = {};
            
            selectedApartments.forEach((apartment, index) => {
                if (!monthlyAverageData[apartment]) return;
                
                const data = filteredMonths.map(month => {
                    return monthlyAverageData[apartment][month] || null;
                });
                
                // ìµœê³ ê°€ì™€ ìµœì €ê°€ ì°¾ê¸°
                const validData = data.filter(value => value !== null);
                if (validData.length > 0) {
                    const maxPrice = Math.max(...validData);
                    const minPrice = Math.min(...validData);
                    const maxIndex = data.findIndex(value => value === maxPrice);
                    const minIndex = data.findIndex(value => value === minPrice);
                    
                    highlightData[apartment] = {
                        maxPrice: maxPrice,
                        minPrice: minPrice,
                        maxMonth: labels[maxIndex],
                        minMonth: labels[minIndex],
                        maxIndex: maxIndex,
                        minIndex: minIndex
                    };
                }
                
                // í¬ì¸íŠ¸ ìŠ¤íƒ€ì¼ ì„¤ì • (ìµœê³ ê°€/ìµœì €ê°€ ê°•ì¡°)
                const pointBackgroundColor = data.map((value, i) => {
                    if (value === highlightData[apartment]?.maxPrice) {
                        return '#e74c3c'; // ìµœê³ ê°€ - ë¹¨ê°„ìƒ‰
                    } else if (value === highlightData[apartment]?.minPrice) {
                        return '#27ae60'; // ìµœì €ê°€ - ì´ˆë¡ìƒ‰
                    }
                    return colors[index % colors.length]; // ì¼ë°˜ í¬ì¸íŠ¸
                });
                
                const pointRadius = data.map((value, i) => {
                    if (value === highlightData[apartment]?.maxPrice || value === highlightData[apartment]?.minPrice) {
                        return 8; // ìµœê³ ê°€/ìµœì €ê°€ëŠ” ë” í° í¬ì¸íŠ¸
                    }
                    return 4; // ì¼ë°˜ í¬ì¸íŠ¸
                });
                
                const pointBorderWidth = data.map((value, i) => {
                    if (value === highlightData[apartment]?.maxPrice || value === highlightData[apartment]?.minPrice) {
                        return 3; // ìµœê³ ê°€/ìµœì €ê°€ëŠ” ë‘êº¼ìš´ í…Œë‘ë¦¬
                    }
                    return 2; // ì¼ë°˜ í¬ì¸íŠ¸
                });
                
                datasets.push({
                    label: apartment,
                    data: data,
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '20',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1,
                    pointBackgroundColor: pointBackgroundColor,
                    pointBorderColor: colors[index % colors.length],
                    pointRadius: pointRadius,
                    pointBorderWidth: pointBorderWidth,
                    pointHoverRadius: 10
                });
            });
            
            return {
                labels: labels,
                datasets: datasets,
                rawData: monthlyAverageData,
                highlightData: highlightData
            };
        }

        // ê·¸ë˜í”„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateGraph() {
            const graphDataResult = calculateMonthlyAveragePricePerArea();
            if (!graphDataResult) {
                showError('ê·¸ë˜í”„ ë°ì´í„°ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const { labels, datasets, rawData, highlightData } = graphDataResult;
            
            const ctx = document.getElementById('price-chart').getContext('2d');
            const graphType = document.getElementById('graph-type-select').value;
            
            // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
            if (priceChart) {
                priceChart.destroy();
            }
            
            // ìƒˆ ì°¨íŠ¸ ìƒì„±
            priceChart = new Chart(ctx, {
                type: graphType,
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'ì›”ë³„ ì•„íŒŒíŠ¸ í‰ê·  í‰ë‹¨ê°€(3.3ã¡ ê¸°ì¤€)',
                            font: {
                                size: 16
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        const value = context.parsed.y;
                                        let tooltipText = value.toLocaleString() + 'ë§Œì›/3.3ã¡';
                                        
                                        // ìµœê³ ê°€/ìµœì €ê°€ í‘œì‹œ
                                        const apartment = context.dataset.label;
                                        const highlight = highlightData[apartment];
                                        if (highlight) {
                                            if (value === highlight.maxPrice) {
                                                tooltipText += ' ğŸ”º ìµœê³ ê°€';
                                            } else if (value === highlight.minPrice) {
                                                tooltipText += ' ğŸ”» ìµœì €ê°€';
                                            }
                                        }
                                        
                                        return tooltipText;
                                    }
                                    return label;
                                }
                            }
                        },
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'í‰ê·  í‰ë‹¨ê°€ (ë§Œì›/3.3ã¡)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + 'ë§Œì›';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'ê³„ì•½ë…„ì›”'
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
            
            // ê·¸ë˜í”„ ë°ì´í„° ì •ë³´ í‘œì‹œ
            displayGraphDataInfo(rawData, labels, highlightData);
        }

        // ê·¸ë˜í”„ ë°ì´í„° ì •ë³´ í‘œì‹œ í•¨ìˆ˜
        function displayGraphDataInfo(rawData, labels, highlightData) {
            const infoElement = document.getElementById('graph-data-info');
            const highlightElement = document.getElementById('highlight-info');
            
            infoElement.style.display = 'block';
            highlightElement.style.display = 'block';
            
            // ìµœê³ ê°€/ìµœì €ê°€ ì •ë³´ í‘œì‹œ
            let highlightHTML = '<strong>ğŸ“ˆ ì•„íŒŒíŠ¸ë³„ ìµœê³ ê°€/ìµœì €ê°€:</strong><br>';
            
            Object.keys(highlightData).forEach(apartment => {
                const data = highlightData[apartment];
                highlightHTML += `
                    <br><strong>${apartment}:</strong>
                    <span style="color: #e74c3c; font-weight: bold;">ìµœê³ ê°€ ${data.maxPrice.toLocaleString()}ë§Œì› (${data.maxMonth})</span> | 
                    <span style="color: #27ae60; font-weight: bold;">ìµœì €ê°€ ${data.minPrice.toLocaleString()}ë§Œì› (${data.minMonth})</span>
                `;
            });
            
            highlightElement.innerHTML = highlightHTML;
            
            // ê¸°ì¡´ ë°ì´í„° ì •ë³´ í‘œì‹œ
            let infoHTML = '<strong>ì›”ë³„ í‰ê·  í‰ë‹¨ê°€ ë°ì´í„° (3.3ã¡ ê¸°ì¤€):</strong><br>';
            
            Object.keys(rawData).forEach(apartment => {
                infoHTML += `<br><strong>${apartment}:</strong> `;
                const monthlyData = [];
                
                labels.forEach((label, index) => {
                    const monthKey = label.replace('ë…„ ', '').replace('ì›”', '');
                    const year = '20' + monthKey.substring(0, 2); // 23ë…„ â†’ 2023
                    const month = monthKey.substring(2, 4);
                    const key = year + month;
                    
                    if (rawData[apartment][key]) {
                        const price = rawData[apartment][key];
                        let priceText = `${label}: ${price.toLocaleString()}ë§Œì›/3.3ã¡`;
                        
                        // ìµœê³ ê°€/ìµœì €ê°€ ê°•ì¡°
                        const highlight = highlightData[apartment];
                        if (highlight && price === highlight.maxPrice) {
                            priceText = `<span style="color: #e74c3c; font-weight: bold;">${priceText} ğŸ”º</span>`;
                        } else if (highlight && price === highlight.minPrice) {
                            priceText = `<span style="color: #27ae60; font-weight: bold;">${priceText} ğŸ”»</span>`;
                        }
                        
                        monthlyData.push(priceText);
                    }
                });
                
                infoHTML += monthlyData.join(', ');
            });
            
            infoElement.innerHTML = infoHTML;
        }

        // ì»¬ëŸ¼ ë§¤í•‘ í•¨ìˆ˜ - í‰ë‹¨ê°€(T) ì»¬ëŸ¼ ì¶”ê°€
        function detectColumnMapping(columns, sampleData) {
            const mapping = {
                apartment: [],
                address1: [],
                address2: [],
                address3: [],
                area: [],
                price: [],
                pricePerArea: [], // í‰ë‹¨ê°€(T) ì»¬ëŸ¼
                date: [],
                floor: []
            };

            columns.forEach(col => {
                const colName = col.name.toLowerCase();
                
                if (colName.includes('ì•„íŒŒíŠ¸') || colName.includes('apt') || colName.includes('ë‹¨ì§€') || colName.includes('ëª…')) {
                    mapping.apartment.push(col.name);
                }
                else if (colName.includes('ì£¼ì†Œ1') || colName.includes('address1') || colName.includes('ì‹œë„') || colName.includes('ì‹œ/ë„')) {
                    mapping.address1.push(col.name);
                }
                else if (colName.includes('ì£¼ì†Œ2') || colName.includes('address2') || colName.includes('ì‹œêµ°êµ¬') || colName.includes('ì‹œ/êµ°/êµ¬')) {
                    mapping.address2.push(col.name);
                }
                else if (colName.includes('ì£¼ì†Œ3') || colName.includes('address3') || colName.includes('ìë©´ë™') || colName.includes('ì/ë©´/ë™') || colName.includes('ë™')) {
                    mapping.address3.push(col.name);
                }
                else if (colName.includes('ë©´ì ') || colName.includes('ì „ìš©ë©´ì ') || colName.includes('í¬ê¸°') || colName.includes('ì œê³±ë¯¸í„°') || colName.includes('í‰ìˆ˜')) {
                    mapping.area.push(col.name);
                }
                else if (colName.includes('ê±°ë˜ê¸ˆì•¡') || colName.includes('ê°€ê²©') || colName.includes('ê¸ˆì•¡') || colName.includes('ë§¤ë§¤') || colName.includes('ì „ì„¸') || colName.includes('ë³´ì¦ê¸ˆ')) {
                    mapping.price.push(col.name);
                }
                else if (colName.includes('í‰ë‹¨ê°€') || colName.includes('ë‹¨ê°€') || colName.includes('í‰ë‹¹ê°€') || colName.includes('price_per') || colName.includes('ë‹¨ìœ„ê°€ê²©')) {
                    mapping.pricePerArea.push(col.name);
                }
                else if (colName.includes('ê³„ì•½ì¼') || colName.includes('ë…„') || colName.includes('ì›”') || colName.includes('ì¼') || colName.includes('ë‚ ì§œ')) {
                    mapping.date.push(col.name);
                }
                else if (colName.includes('ì¸µ') || colName.includes('floor') || colName.includes('ì¸µìˆ˜')) {
                    mapping.floor.push(col.name);
                }
            });

            // í‰ë‹¨ê°€(T) ì»¬ëŸ¼ì„ íŠ¹ë³„íˆ ì°¾ê¸°
            columns.forEach(col => {
                if (col.name === 'í‰ë‹¨ê°€(T)' || col.name === 'í‰ë‹¨ê°€' || col.name.includes('í‰ë‹¨ê°€')) {
                    if (!mapping.pricePerArea.includes(col.name)) {
                        mapping.pricePerArea.unshift(col.name); // ìš°ì„ ìˆœìœ„ ë†’ì„
                    }
                }
            });

            if (sampleData && sampleData.values && sampleData.values.length > 0) {
                const firstRow = sampleData.values[0];
                columns.forEach((col, index) => {
                    const value = firstRow[index];
                    if (value && typeof value === 'string') {
                        if ((value.includes('ì„œìš¸') || value.includes('ê²½ê¸°') || value.includes('ì¸ì²œ') || 
                             value.includes('ë¶€ì‚°') || value.includes('ëŒ€êµ¬') || value.includes('ê´‘ì£¼') || 
                             value.includes('ëŒ€ì „') || value.includes('ìš¸ì‚°') || value.includes('ì„¸ì¢…') ||
                             value.includes('ê°•ì›') || value.includes('ì¶©ë¶') || value.includes('ì¶©ë‚¨') ||
                             value.includes('ì „ë¶') || value.includes('ì „ë‚¨') || value.includes('ê²½ë¶') || 
                             value.includes('ê²½ë‚¨') || value.includes('ì œì£¼')) && 
                            !mapping.address1.includes(col.name)) {
                            mapping.address1.push(col.name);
                        }
                        
                        if ((value.includes('êµ¬') && !value.includes('ì‹œêµ°êµ¬')) && !mapping.address2.includes(col.name)) {
                            mapping.address2.push(col.name);
                        }
                        
                        if (value.includes('ë™') && !value.includes('ìë©´ë™') && !mapping.address3.includes(col.name)) {
                            mapping.address3.push(col.name);
                        }
                        
                        if ((value.includes('ì•„íŒŒíŠ¸') || value.includes('APT') || value.includes('ë‹¨ì§€')) && 
                            !mapping.apartment.includes(col.name)) {
                            mapping.apartment.push(col.name);
                        }
                    }
                });
            }

            const finalMapping = {};
            Object.keys(mapping).forEach(key => {
                if (mapping[key].length > 0) {
                    const koreanCols = mapping[key].filter(col => /[ê°€-í£]/.test(col));
                    if (koreanCols.length > 0) {
                        finalMapping[key] = koreanCols[0];
                    } else {
                        finalMapping[key] = mapping[key][0];
                    }
                }
            });

            return finalMapping;
        }

        // ë°ì´í„°ë² ì´ìŠ¤ ë¡œë“œ í•¨ìˆ˜
        async function loadDatabase() {
            const fileInput = document.getElementById('db-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!SQL) {
                showError('SQL.jsê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('error-message').style.display = 'none';

            try {
                const arrayBuffer = await file.arrayBuffer();
                const uint8Array = new Uint8Array(arrayBuffer);
                
                db = new SQL.Database(uint8Array);
                
                const tablesResult = db.exec("SELECT name FROM sqlite_master WHERE type='table'");
                
                if (tablesResult.length === 0) {
                    throw new Error('ë°ì´í„°ë² ì´ìŠ¤ì— í…Œì´ë¸”ì´ ì—†ìŠµë‹ˆë‹¤.');
                }

                const tableName = tablesResult[0].values[0][0];
                
                const tableInfoResult = db.exec(`PRAGMA table_info(${tableName})`);
                const columns = tableInfoResult[0].values.map(row => ({
                    name: row[1],
                    type: row[2]
                }));

                const sampleResult = db.exec(`SELECT * FROM ${tableName} LIMIT 10`);
                
                tableInfo = {
                    name: tableName,
                    columns: columns,
                    sample: sampleResult.length > 0 ? sampleResult[0] : null
                };

                columnMapping = detectColumnMapping(columns, sampleResult.length > 0 ? sampleResult[0] : null);

                updateDatabaseInfo(tableInfo, columnMapping);
                
                document.getElementById('search-section').style.display = 'block';
                
                setupTableHeaders(columns);
                
                currentPage = 1;
                loadInitialData();
                
            } catch (error) {
                console.error('ë°ì´í„°ë² ì´ìŠ¤ ë¡œë“œ ì˜¤ë¥˜:', error);
                showError('ë°ì´í„°ë² ì´ìŠ¤ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function updateDatabaseInfo(info, mapping) {
            const infoElement = document.getElementById('database-info');
            const mappingElement = document.getElementById('column-mapping-info');
            
            infoElement.innerHTML = `
                <strong>íŒŒì¼:</strong> ${document.getElementById('db-file').files[0].name} | 
                <strong>í…Œì´ë¸”:</strong> ${info.name} | 
                <strong>ì»¬ëŸ¼ìˆ˜:</strong> ${info.columns.length}ê°œ
            `;
            
            let mappingHTML = '<strong>ìë™ ê°ì§€ëœ ì»¬ëŸ¼ ë§¤í•‘:</strong> ';
            const mappingItems = [];
            
            if (mapping.apartment) mappingItems.push(`ì•„íŒŒíŠ¸ëª…: ${mapping.apartment}`);
            if (mapping.address1) mappingItems.push(`ì‹œ/ë„: ${mapping.address1}`);
            if (mapping.address2) mappingItems.push(`ì‹œ/êµ°/êµ¬: ${mapping.address2}`);
            if (mapping.address3) mappingItems.push(`ì/ë©´/ë™: ${mapping.address3}`);
            if (mapping.area) mappingItems.push(`ë©´ì : ${mapping.area}`);
            if (mapping.price) mappingItems.push(`ê°€ê²©: ${mapping.price}`);
            if (mapping.pricePerArea) mappingItems.push(`í‰ë‹¨ê°€: ${mapping.pricePerArea}`);
            if (mapping.date) mappingItems.push(`ë‚ ì§œ: ${mapping.date}`);
            if (mapping.floor) mappingItems.push(`ì¸µìˆ˜: ${mapping.floor}`);
            
            mappingHTML += mappingItems.join(' | ') || 'ë§¤í•‘ëœ ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤ (ì „ì²´ ì»¬ëŸ¼ì—ì„œ ê²€ìƒ‰ë©ë‹ˆë‹¤)';
            mappingElement.innerHTML = mappingHTML;
        }

        function setupTableHeaders(columns) {
            const headersRow = document.getElementById('table-headers');
            headersRow.innerHTML = '';
            
            columns.forEach(column => {
                const th = document.createElement('th');
                th.textContent = column.name;
                th.title = column.name;
                headersRow.appendChild(th);
            });
        }

        function loadInitialData() {
            if (!db || !tableInfo) {
                showError('ë°ì´í„°ë² ì´ìŠ¤ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                const countResult = db.exec(`SELECT COUNT(*) as total FROM ${tableInfo.name}`);
                totalItems = countResult[0]?.values[0]?.[0] || 0;

                const dataResult = db.exec(`SELECT * FROM ${tableInfo.name} LIMIT ${itemsPerPage}`);
                
                if (dataResult.length > 0) {
                    currentData = dataResult[0];
                    // ì „ì²´ ë°ì´í„°ë„ allSearchDataì— ì €ì¥
                    allSearchData = currentData;
                    displayResults(currentData);
                    updateStats(totalItems, currentData.values.length);
                } else {
                    displayResults(null);
                    allSearchData = { columns: [], values: [] };
                }
                
            } catch (error) {
                console.error('ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                showError('ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                allSearchData = { columns: [], values: [] };
            }
        }

        // ì „ì²´ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
        function loadAllData() {
            if (!db || !tableInfo) {
                showError('ë°ì´í„°ë² ì´ìŠ¤ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            document.getElementById('loading').style.display = 'block';

            try {
                const dataResult = db.exec(`SELECT * FROM ${tableInfo.name}`);
                
                if (dataResult.length > 0) {
                    currentData = dataResult[0];
                    allData = currentData;
                    // ì „ì²´ ë°ì´í„°ë„ allSearchDataì— ì €ì¥
                    allSearchData = currentData;
                    displayResults(currentData);
                    updateStats(currentData.values.length, currentData.values.length);
                    
                    document.getElementById('pagination').style.display = 'none';
                } else {
                    displayResults(null);
                    allSearchData = { columns: [], values: [] };
                }
                
            } catch (error) {
                console.error('ì „ì²´ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                showError('ì „ì²´ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                allSearchData = { columns: [], values: [] };
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // ê²€ìƒ‰ í•¨ìˆ˜ - ì „ì²´ ê²€ìƒ‰ ê²°ê³¼ ì €ì¥
        function searchAptData() {
            if (!db || !tableInfo) {
                showError('ë°ì´í„°ë² ì´ìŠ¤ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            const address1 = document.getElementById('address1').value;
            const address2 = document.getElementById('address2').value;
            const address3 = document.getElementById('address3').value;
            const aptName = document.getElementById('apt-name').value;
            const contractYearFrom = document.getElementById('contract-year-from').value;
            const contractYearTo = document.getElementById('contract-year-to').value;
            const minPrice = document.getElementById('min-price').value;
            const maxPrice = document.getElementById('max-price').value;
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('table-container').style.display = 'none';
            document.getElementById('no-results').style.display = 'none';
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('pagination').style.display = 'none';
            document.getElementById('stats').style.display = 'none';
            document.getElementById('graph-section').style.display = 'none';
            
            try {
                let whereConditions = [];
                let params = [];
                
                if (address1) {
                    if (columnMapping.address1) {
                        whereConditions.push(`${columnMapping.address1} LIKE ?`);
                        params.push(`%${address1}%`);
                    } else {
                        const textColumns = tableInfo.columns.filter(col => 
                            col.type.toLowerCase().includes('char') || 
                            col.type.toLowerCase().includes('text') ||
                            col.type === ''
                        );
                        
                        if (textColumns.length > 0) {
                            const conditions = textColumns.map(col => `${col.name} LIKE ?`).join(' OR ');
                            whereConditions.push(`(${conditions})`);
                            params.push(...Array(textColumns.length).fill(`%${address1}%`));
                        }
                    }
                }
                
                if (address2) {
                    if (columnMapping.address2) {
                        whereConditions.push(`${columnMapping.address2} LIKE ?`);
                        params.push(`%${address2}%`);
                    }
                }
                
                if (address3) {
                    if (columnMapping.address3) {
                        whereConditions.push(`${columnMapping.address3} LIKE ?`);
                        params.push(`%${address3}%`);
                    }
                }
                
                if (aptName) {
                    if (columnMapping.apartment) {
                        const words = aptName.split(' ').filter(word => word.length > 0);
                        if (words.length > 0) {
                            const aptConditions = words.map(word => `${columnMapping.apartment} LIKE ?`).join(' AND ');
                            whereConditions.push(`(${aptConditions})`);
                            words.forEach(word => params.push(`%${word}%`));
                        }
                    } else {
                        const textColumns = tableInfo.columns.filter(col => 
                            col.type.toLowerCase().includes('char') || 
                            col.type.toLowerCase().includes('text') ||
                            col.type === ''
                        );
                        
                        if (textColumns.length > 0) {
                            const words = aptName.split(' ').filter(word => word.length > 0);
                            if (words.length > 0) {
                                const columnConditions = textColumns.map(col => {
                                    const wordConditions = words.map(() => `${col.name} LIKE ?`).join(' AND ');
                                    return `(${wordConditions})`;
                                }).join(' OR ');
                                
                                whereConditions.push(`(${columnConditions})`);
                                words.forEach(word => {
                                    params.push(...Array(textColumns.length).fill(`%${word}%`));
                                });
                            }
                        }
                    }
                }
                
                if (contractYearFrom || contractYearTo) {
                    if (columnMapping.date) {
                        let dateCondition = '';
                        
                        if (contractYearFrom && contractYearTo) {
                            const fromNumber = parseInt(contractYearFrom.replace('-', ''));
                            const toNumber = parseInt(contractYearTo.replace('-', ''));
                            
                            dateCondition = `CAST(SUBSTR(${columnMapping.date}, 1, 6) AS INTEGER) BETWEEN ? AND ?`;
                            params.push(fromNumber, toNumber);
                        } else if (contractYearFrom) {
                            const fromNumber = parseInt(contractYearFrom.replace('-', ''));
                            dateCondition = `CAST(SUBSTR(${columnMapping.date}, 1, 6) AS INTEGER) >= ?`;
                            params.push(fromNumber);
                        } else if (contractYearTo) {
                            const toNumber = parseInt(contractYearTo.replace('-', ''));
                            dateCondition = `CAST(SUBSTR(${columnMapping.date}, 1, 6) AS INTEGER) <= ?`;
                            params.push(toNumber);
                        }
                        
                        if (dateCondition) {
                            whereConditions.push(dateCondition);
                        }
                    }
                }
                
                if (minPrice || maxPrice) {
                    let priceCondition = '';
                    
                    if (columnMapping.price) {
                        const priceColumn = columnMapping.price;
                        
                        if (minPrice && maxPrice) {
                            priceCondition = `CAST(${priceColumn} AS REAL) BETWEEN ? AND ?`;
                            params.push(parseFloat(minPrice), parseFloat(maxPrice));
                        } else if (minPrice) {
                            priceCondition = `CAST(${priceColumn} AS REAL) >= ?`;
                            params.push(parseFloat(minPrice));
                        } else if (maxPrice) {
                            priceCondition = `CAST(${priceColumn} AS REAL) <= ?`;
                            params.push(parseFloat(maxPrice));
                        }
                        
                        if (priceCondition) {
                            whereConditions.push(priceCondition);
                        }
                    }
                }
                
                const whereClause = whereConditions.length > 0 ? `WHERE ${whereConditions.join(' AND ')}` : '';
                
                // ì „ì²´ ê²€ìƒ‰ ê²°ê³¼ ìˆ˜ ì¡°íšŒ
                const countQuery = `SELECT COUNT(*) as total FROM ${tableInfo.name} ${whereClause}`;
                const countResult = db.exec(countQuery, params);
                totalItems = countResult[0]?.values[0]?.[0] || 0;
                
                // í˜ì´ì§€ë„¤ì´ì…˜ì„ ìœ„í•œ í˜„ì¬ í˜ì´ì§€ ë°ì´í„° ì¡°íšŒ
                const offset = (currentPage - 1) * itemsPerPage;
                const dataQuery = `SELECT * FROM ${tableInfo.name} ${whereClause} LIMIT ? OFFSET ?`;
                const dataParams = [...params, itemsPerPage, offset];
                
                const dataResult = db.exec(dataQuery, dataParams);
                
                // â˜… ì¤‘ìš”: ê·¸ë˜í”„ë¥¼ ìœ„í•œ ì „ì²´ ê²€ìƒ‰ ê²°ê³¼ ì¡°íšŒ
                const allDataQuery = `SELECT * FROM ${tableInfo.name} ${whereClause}`;
                const allDataResult = db.exec(allDataQuery, params);
                
                if (dataResult.length > 0) {
                    currentData = dataResult[0];
                    // ì „ì²´ ê²€ìƒ‰ ê²°ê³¼ ì €ì¥ (ê·¸ë˜í”„ìš©)
                    allSearchData = allDataResult.length > 0 ? allDataResult[0] : { columns: [], values: [] };
                    displayResults(currentData);
                    setupPagination(totalItems);
                    updateStats(totalItems, currentData.values.length);
                } else {
                    displayResults(null);
                    allSearchData = { columns: [], values: [] };
                }
                
            } catch (error) {
                console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                showError('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                allSearchData = { columns: [], values: [] };
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        function displayResults(data) {
            if (!data || !data.values || data.values.length === 0) {
                document.getElementById('no-results').style.display = 'block';
                document.getElementById('no-results').textContent = 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
                document.getElementById('pagination').style.display = 'none';
                document.getElementById('stats').style.display = 'none';
                document.getElementById('graph-section').style.display = 'none';
                return;
            }
            
            const tbody = document.getElementById('results-body');
            tbody.innerHTML = '';
            
            const dateColumnIndex = tableInfo.columns.findIndex(col => 
                columnMapping.date === col.name
            );
            const pricePerAreaColumnIndex = tableInfo.columns.findIndex(col => 
                columnMapping.pricePerArea === col.name
            );
            
            data.values.forEach(row => {
                const tr = document.createElement('tr');
                
                row.forEach((cell, index) => {
                    const td = document.createElement('td');
                    
                    if (index === dateColumnIndex) {
                        td.innerHTML = `<span class="contract-date">${formatContractDate(cell)}</span>`;
                    } else if (index === pricePerAreaColumnIndex) {
                        // í‰ë‹¨ê°€(T) ì»¬ëŸ¼ ê°•ì¡° í‘œì‹œ
                        if (cell !== null && cell !== undefined) {
                            const pricePerArea = parseFloat(cell);
                            if (!isNaN(pricePerArea)) {
                                td.innerHTML = `<span class="price-per-area">${pricePerArea.toLocaleString()}ë§Œì›/3.3ã¡</span>`;
                            } else {
                                td.textContent = cell;
                            }
                        } else {
                            td.textContent = '-';
                        }
                    } else {
                        if (cell === null || cell === undefined) {
                            td.textContent = '-';
                        } else if (typeof cell === 'number') {
                            td.textContent = cell.toLocaleString();
                        } else {
                            td.textContent = cell;
                        }
                    }
                    
                    td.title = cell;
                    tr.appendChild(td);
                });
                
                tbody.appendChild(tr);
            });
            
            document.getElementById('table-container').style.display = 'block';
            document.getElementById('pagination').style.display = 'flex';
            document.getElementById('stats').style.display = 'block';
            
            // ìŠ¤í¬ë¡¤ íŒíŠ¸ í‘œì‹œ
            document.getElementById('scroll-hint').style.display = 'block';
        }
        
        function updateStats(total, displayed) {
            document.getElementById('total-count').textContent = total.toLocaleString();
            document.getElementById('display-count').textContent = displayed.toLocaleString();
        }
        
        function setupPagination(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const paginationContainer = document.getElementById('pagination');
            paginationContainer.innerHTML = '';
            
            if (totalPages <= 1) {
                document.getElementById('pagination').style.display = 'none';
                return;
            }
            
            const prevButton = document.createElement('button');
            prevButton.innerHTML = '&laquo;';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    searchAptData();
                }
            });
            paginationContainer.appendChild(prevButton);
            
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.classList.toggle('active', i === currentPage);
                pageButton.addEventListener('click', () => {
                    currentPage = i;
                    searchAptData();
                });
                paginationContainer.appendChild(pageButton);
            }
            
            const nextButton = document.createElement('button');
            nextButton.innerHTML = '&raquo;';
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    searchAptData();
                }
            });
            paginationContainer.appendChild(nextButton);
        }
        
        // ì—‘ì…€ ì €ì¥ í•¨ìˆ˜
        function exportToExcel() {
            if (!currentData || !currentData.values || currentData.values.length === 0) {
                showError('ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                const wb = XLSX.utils.book_new();
                
                const dateColumnIndex = tableInfo.columns.findIndex(col => 
                    columnMapping.date === col.name
                );
                
                const excelData = currentData.values.map(row => {
                    const obj = {};
                    tableInfo.columns.forEach((col, index) => {
                        let value = row[index];
                        
                        if (index === dateColumnIndex) {
                            value = formatContractDate(value);
                        } else if (typeof value === 'number') {
                            value = value;
                        } else if (value === null || value === undefined) {
                            value = '';
                        }
                        
                        obj[col.name] = value;
                    });
                    return obj;
                });
                
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                XLSX.utils.book_append_sheet(wb, ws, 'ì•„íŒŒíŠ¸ì‹œì„¸');
                
                const fileName = `ì•„íŒŒíŠ¸ì‹œì„¸_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
            } catch (error) {
                console.error('ì—‘ì…€ ì €ì¥ ì˜¤ë¥˜:', error);
                showError('ì—‘ì…€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        function showError(message) {
            document.getElementById('error-message').style.display = 'block';
            document.getElementById('error-message').textContent = message;
            document.getElementById('loading').style.display = 'none';
        }
    </script>
</body>
</html>